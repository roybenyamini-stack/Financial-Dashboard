<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>×ª×™×§ ×”×©×§×¢×•×ª</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'Heebo', sans-serif;
  background: #f0f2f5;
  color: #1a1a2e;
  min-height: 100vh;
  padding: 20px;
}

/* HEADER */
.header {
  background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
  border-radius: 20px;
  padding: 24px 32px;
  margin-bottom: 20px;
  color: white;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 8px 32px rgba(15,52,96,0.3);
}
.header-title h1 { font-size: 20px; font-weight: 800; }
.header-title p { font-size: 12px; opacity: 0.5; margin-top: 3px; }
.header-stats { display: flex; gap: 36px; align-items: center; }
.stat-item { text-align: center; display: flex; flex-direction: column; align-items: center; }
.stat-value { margin-top: 8px; margin-bottom: 4px; }
.stat-label { font-size: 10px; opacity: 0.5; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 3px; }
.stat-value { font-size: 24px; font-weight: 800; letter-spacing: -1px; }
.stat-value.green { color: #4ade80; }
.stat-change { font-size: 11px; opacity: 0.6; margin-top: 2px; }
.divider { width: 1px; height: 44px; background: rgba(255,255,255,0.12); }

/* CARDS */
.cards-row {
  display: grid;
  grid-template-columns: auto repeat(9, 1fr);
  gap: 14px;
  margin-bottom: 20px;
}
.card-total {
  background: #1a1a2e;
  border-radius: 14px;
  padding: 16px 22px;
  color: white;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  flex-direction: column;
  justify-content: center;
  min-width: 130px;
  border: 2px solid transparent;
}
.card-total.active, .card-total:hover { background: #0f3460; transform: translateY(-2px); }
.card-total .label { font-size: 10px; opacity: 0.6; text-transform: uppercase; letter-spacing: 0.8px; }
.card-total .value { font-size: 20px; font-weight: 800; margin-top: 4px; }
.card-total .change { font-size: 11px; color: #4ade80; margin-top: 3px; }

.card {
  background: white;
  border-radius: 14px;
  padding: 16px 20px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.06);
  border-right: 4px solid var(--cat-color);
  cursor: pointer;
  transition: all 0.2s;
  border: 2px solid transparent;
  border-right: 4px solid var(--cat-color);
}
.card:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
.card.active { border: 2px solid var(--cat-color); border-right: 4px solid var(--cat-color); box-shadow: 0 0 0 3px var(--cat-color-alpha); }
.card .card-label { font-size: 11px; color: #999; font-weight: 500; margin-bottom: 5px; }
.card .card-value { font-size: 20px; font-weight: 800; color: #1a1a2e; }
.card .card-change { font-size: 11px; font-weight: 600; margin-top: 5px; }
.card .card-change.pos { color: #16a34a; }

/* CHART SECTION */
.chart-section {
  background: white;
  border-radius: 18px;
  padding: 24px 28px;
  margin-bottom: 20px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.06);
  width: 100%;
  box-sizing: border-box;
}
.chart-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 6px;
}
.chart-title { font-size: 15px; font-weight: 700; }
.chart-subtitle { font-size: 11px; color: #aaa; margin-top: 2px; }

.active-label {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  background: #f5f5f5;
  border-radius: 20px;
  padding: 5px 14px;
  font-size: 12px;
  font-weight: 600;
  color: #333;
  transition: all 0.3s;
}
.active-label .dot {
  width: 8px; height: 8px; border-radius: 50%;
  background: var(--active-color, #1a1a2e);
}
.chart-container { height: 240px; margin-top: 16px; width: 100%; position: relative; }
@media (max-width: 900px) {
  .chart-container { height: 200px; }
  .chart-section { padding: 16px; }
  .chart-header { flex-direction: column; gap: 8px; }
}

/* CATEGORY SECTIONS */
.category-section {
  background: white;
  border-radius: 14px;
  margin-bottom: 12px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.05);
  overflow: hidden;
}

.category-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 22px;
  cursor: pointer;
  border-right: 4px solid var(--cat-color);
  transition: background 0.15s;
  user-select: none;
}
.category-header:hover { background: #fafafa; }
.category-header.active { background: var(--cat-color-ultralight); }

.cat-header-right { display: flex; align-items: center; gap: 12px; }
.cat-icon { width: 34px; height: 34px; border-radius: 10px; background: var(--cat-color-light); display: flex; align-items: center; justify-content: center; font-size: 15px; }
.cat-name { font-size: 14px; font-weight: 700; }
.cat-count { font-size: 11px; color: #aaa; margin-top: 1px; }
.cat-header-left { display: flex; align-items: center; gap: 16px; }
.cat-total { font-size: 17px; font-weight: 800; }
.cat-pct { font-size: 12px; font-weight: 600; padding: 3px 10px; border-radius: 20px; }
.cat-pct.pos { background: #dcfce7; color: #16a34a; }
.chevron { font-size: 11px; color: #ccc; transition: transform 0.25s; }
.chevron.open { transform: rotate(180deg); }

/* BODY / TABLE */
.category-body { display: none; border-top: 1px solid #f5f5f5; overflow-x: auto; scroll-behavior: smooth; }
.category-body.open { display: block; }

table { width: 100%; border-collapse: collapse; font-size: 11.5px; direction: ltr; }
th {
  padding: 9px 12px;
  text-align: center;
  font-weight: 600;
  color: #888;
  background: #fafafa;
  border-bottom: 1px solid #f0f0f0;
  white-space: nowrap;
}
th:first-child { text-align: right; min-width: 200px; direction: rtl; }
td { padding: 9px 12px; text-align: center; border-bottom: 1px solid #f9f9f9; vertical-align: top; }
td:first-child { text-align: right; font-weight: 600; color: #333; white-space: nowrap; direction: rtl; }
tr:hover td { background: #f8faff; cursor: pointer; }
tr.fund-active td { background: #fffbf0 !important; }
tr:last-child td { border-bottom: none; }

.val { font-weight: 600; color: #1a1a2e; }
.val small { display: block; font-size: 10px; }
.dpos { color: #16a34a; }
.dneg { color: #dc2626; }
.dzer { color: #ccc; }
.dash { color: #ddd; }

.total-row td { font-weight: 700 !important; background: #f8f9ff !important; border-top: 2px solid #e8eaf6; }
.note { display: inline-block; font-size: 9px; padding: 1px 5px; border-radius: 6px; background: #fff3cd; color: #856404; margin-right: 3px; vertical-align: middle; }
.delta-row { display: none; background: #f8faff; }
.delta-row.visible { display: table-row; }
.delta-row td { font-size: 11px; padding: 3px 12px; border-bottom: 1px solid #f0f0f0; color: #888; }
.delta-row td:first-child { color: #aaa; font-style: italic; font-size: 10px; }
.dval { font-weight: 600; }
</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <div class="header-title">
    <h1>ğŸ“Š ×ª×™×§ ×”×©×§×¢×•×ª</h1>
    <p id="hdr-subtitle" style="color:white; font-weight:700; font-size:13px;">××¦×™×’: ×¤×‘×¨×³ 26</p>
  </div>
  <div class="header-stats">
    <div class="stat-item">
      <div class="stat-label">×¡×”×´×› × ×›×¡×™×</div>
      <div class="stat-value" id="hdr-total">14,964</div>
      <div class="stat-change">××œ×¤×™ ×©×´×—</div>
    </div>
    <div class="divider"></div>
    <div class="stat-item" style="padding-top: 18px;">
      <div class="stat-label">×©×™× ×•×™ ×›×•×œ×œ</div>
      <div class="stat-value green" id="hdr-change-val">4,036</div>
      <div class="stat-change" style="display:flex; flex-direction:column; gap:2px; font-size:11px; color:white;">
        <span style="color:white;">ğŸ“ˆ ×ª×©×•××”: <span id="hdr-returns-val" style="color:#4ade80; font-weight:600;">+2,354</span></span>
        <span style="color:white;">ğŸ’° ×”×¤×§×“×•×ª: <span id="hdr-deposits-val" style="color:white; font-weight:600;">1,682</span></span>
      </div>
    </div>
    <div class="divider"></div>
    <div class="stat-item">
      <div class="stat-label">×ª×©×•××” ×× ×•×˜×¨×œ×ª</div>
      <div class="stat-value green" id="hdr-ret-val">25.4%</div>
      <div class="stat-change" id="hdr-ret-range">×™× ×•×³ 2025 â€“ ×¤×‘×¨×³ 26</div>
    </div>
  </div>
  <div style="margin-top:12px; text-align:left;">
    <label id="excel-upload-btn" style="cursor:pointer; background:rgba(255,255,255,0.15); color:white; border:1px solid rgba(255,255,255,0.4); border-radius:8px; padding:7px 14px; font-size:12px; font-family:Heebo,sans-serif; display:inline-block;">
      ğŸ“‚ ×¢×“×›×Ÿ × ×ª×•× ×™× ×××§×¡×œ
      <input type="file" id="excel-file-input" accept=".xlsx,.xls,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel" style="display:none;" onchange="loadExcelFile(this)">
    </label>
    <span id="excel-status" style="color:rgba(255,255,255,0.7); font-size:11px; margin-right:10px;"></span>
    <button onclick="openNotes()" style="cursor:pointer; background:rgba(255,255,255,0.15); color:white; border:1px solid rgba(255,255,255,0.4); border-radius:8px; padding:7px 14px; font-size:12px; font-family:Heebo,sans-serif; margin-right:8px;">ğŸ“ ×”×¢×¨×•×ª</button>
  </div>
</div>

<!-- CARDS -->
<div class="cards-row">
  <div class="card-total active" id="card-all" onclick="selectView('all')">
    <div class="label">×¡×”×´×›</div>
    <div class="value" id="card-val-all">14,964</div>
    <div class="change" id="card-chg-all">+14.7% × ××“×“</div>
  </div>
  <div class="card" style="--cat-color:#0891b2;--cat-color-alpha:#0891b220" id="card-mezuman" onclick="selectView('mezuman')">
    <div class="card-label">××–×•××Ÿ</div>
    <div class="card-value" id="card-val-mezuman">1,105</div>
    <div class="card-change" id="card-chg-mezuman"></div>
  </div>
  <div class="card" style="--cat-color:#dc2626;--cat-color-alpha:#dc262620" id="card-hishtalmut" onclick="selectView('hishtalmut')">
    <div class="card-label">×§×¨× ×•×ª ×”×©×ª×œ××•×ª</div>
    <div class="card-value" id="card-val-hishtalmut">4,606</div>
    <div class="card-change pos" id="card-chg-hishtalmut">â–² +16.9%</div>
  </div>
  <div class="card" style="--cat-color:#b45309;--cat-color-alpha:#b4530920" id="card-gemel" onclick="selectView('gemel')">
    <div class="card-label">×§×•×¤×•×ª ×’××œ</div>
    <div class="card-value" id="card-val-gemel">1,730</div>
    <div class="card-change pos" id="card-chg-gemel">â–² +17.6%</div>
  </div>
  <div class="card" style="--cat-color:#9f1239;--cat-color-alpha:#9f123920" id="card-gemel_invest" onclick="selectView('gemel_invest')">
    <div class="card-label">×’××œ ×œ×”×©×§×¢×”</div>
    <div class="card-value" id="card-val-gemel_invest">902</div>
    <div class="card-change pos" id="card-chg-gemel_invest">â–² +21.8%</div>
  </div>
  <div class="card" style="--cat-color:#a16207;--cat-color-alpha:#a1620720" id="card-harel" onclick="selectView('harel')">
    <div class="card-label">×”×¨××œ</div>
    <div class="card-value" id="card-val-harel">7,126</div>
    <div class="card-change pos" id="card-chg-harel">â–² +15.9%</div>
  </div>
  <div class="card" style="--cat-color:#7c3aed;--cat-color-alpha:#7c3aed20" id="card-meitav" onclick="selectView('meitav')">
    <div class="card-label">××™×˜×‘</div>
    <div class="card-value" id="card-val-meitav">639</div>
    <div class="card-change pos" id="card-chg-meitav">â–² +13.2%</div>
  </div>
</div>

<!-- CHART -->
<div class="chart-section">
  <div class="chart-header">
    <div>
      <div class="chart-title">×”×¦×˜×‘×¨×•×ª × ×›×¡×™×</div>
      <div class="chart-subtitle">×™× ×•××¨ 2025 â€“ ×¤×‘×¨×•××¨ 2026 Â· ×‘××œ×¤×™  Â· ×œ×—×¥ ×¢×œ ×§×˜×’×•×¨×™×” ××• ×§×¨×Ÿ ×œ×¡×™× ×•×Ÿ</div>
      <div style="display:flex;gap:20px;margin-top:8px;">
        <div>
          <div id="chart-accum-label" style="font-size:11px;color:#888;font-family:Heebo,sans-serif;">×¦×‘×™×¨×”</div>
          <div id="chart-accum" style="font-size:15px;font-weight:700;font-family:Heebo,sans-serif;color:#1a1a2e;">â€”</div>
        </div>
        <div>
          <div style="font-size:11px;color:#888;font-family:Heebo,sans-serif;">×’×™×“×•×œ ×‘×—×œ×•×Ÿ</div>
          <div id="chart-growth" style="font-size:15px;font-weight:700;font-family:Heebo,sans-serif;color:#1a1a2e;">â€”</div>
        </div>
        <div>
          <div style="font-size:11px;color:#888;font-family:Heebo,sans-serif;">×ª×©×•××” ×‘×—×œ×•×Ÿ</div>
          <div id="chart-return" style="font-size:15px;font-weight:700;font-family:Heebo,sans-serif;color:#16a34a;">â€”</div>
        </div>
      </div>
    </div>
    <div class="active-label" id="activeLabel" style="--active-color:#1a1a2e">
      <span class="dot"></span>
      <span id="activeLabelText">×¡×”×´×› ×›×œ ×”×§×˜×’×•×¨×™×•×ª</span>
    </div>
  </div>
  <div style="display:flex; align-items:center; justify-content:center; gap:10px; margin-bottom:10px;">
    <button id="btnNext" onclick="slideWindow(1)" title="×ª×§×•×¤×” ×”×‘××”" style="background:#f0f2f5;border:none;border-radius:8px;width:32px;height:32px;font-size:15px;cursor:pointer;color:#555;display:flex;align-items:center;justify-content:center;">&#8594;</button>
    <span id="winRange" style="font-size:13px;color:#555;font-family:Heebo;font-weight:700;min-width:160px;text-align:center;"></span>
    <button id="btnPrev" onclick="slideWindow(-1)" title="×ª×§×•×¤×” ×§×•×“××ª" style="background:#f0f2f5;border:none;border-radius:8px;width:32px;height:32px;font-size:15px;cursor:pointer;color:#555;display:flex;align-items:center;justify-content:center;">&#8592;</button>
  </div>
  <div class="chart-container" dir="ltr">
    <canvas id="mainChart"></canvas>
  </div>
</div>

<!-- NOTES MODAL -->
<div id="notes-modal" onclick="if(event.target===this)closeNotes();" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
  <div style="background:white; border-radius:16px; width:90%; max-width:780px; max-height:85vh; overflow:hidden; display:flex; flex-direction:column; font-family:Heebo,sans-serif;" dir="rtl">
    <div style="background:#1a1a2e; color:white; padding:18px 22px; display:flex; justify-content:space-between; align-items:center;">
      <button onclick="closeNotes()" style="background:none; border:none; color:white; font-size:20px; cursor:pointer;">âœ•</button>
      <span style="font-size:16px; font-weight:700;">ğŸ“ ×”×¢×¨×•×ª ×ª×™×§</span>
      <button onclick="showAddForm()" style="background:rgba(255,255,255,0.2); border:1px solid rgba(255,255,255,0.4); color:white; border-radius:8px; padding:6px 14px; font-size:13px; cursor:pointer; font-family:Heebo,sans-serif;">+ ×”×•×¡×£ ×”×¢×¨×”</button>
    </div>
    <div id="notes-add-form" style="display:none; padding:16px 18px; border-bottom:1px solid #e5e7eb; background:#f9fafb;" dir="rtl">
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px;">
        <div>
          <label style="font-size:11px; color:#888; display:block; margin-bottom:3px;">×ª××¨×™×š</label>
          <input id="nf-date" type="text" placeholder="DD/MM/YYYY" style="width:100%; padding:7px 10px; border:1px solid #d1d5db; border-radius:6px; font-family:Heebo,sans-serif; font-size:13px; box-sizing:border-box;">
        </div>
        <div>
          <label style="font-size:11px; color:#888; display:block; margin-bottom:3px;">×¡×•×’ ××™×¨×•×¢</label>
          <select id="nf-type" style="width:100%; padding:7px 10px; border:1px solid #d1d5db; border-radius:6px; font-family:Heebo,sans-serif; font-size:13px; box-sizing:border-box;">
            <option>××›×™×¨×ª × ×›×¡</option>
            <option>×§× ×™×™×ª × ×›×¡</option>
            <option>×”×›×¨×” ×‘××–×•××Ÿ</option>
            <option>×”×¢×‘×¨×” ×‘×™×Ÿ ×§×¨× ×•×ª</option>
            <option>××—×¨</option>
          </select>
        </div>
      </div>
      <div style="margin-bottom:10px;">
        <label style="font-size:11px; color:#888; display:block; margin-bottom:3px;">×¤×™×¨×•×˜</label>
        <input id="nf-title" type="text" placeholder="×ª×™××•×¨ ×§×¦×¨" style="width:100%; padding:7px 10px; border:1px solid #d1d5db; border-radius:6px; font-family:Heebo,sans-serif; font-size:13px; box-sizing:border-box;">
      </div>
      <div id="nf-fields-sale" style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-bottom:10px;">
        <div>
          <label style="font-size:11px; color:#888; display:block; margin-bottom:3px;">×¡×›×•× ×›×•×œ×œ</label>
          <input id="nf-gross" type="text" placeholder="0" style="width:100%; padding:7px 10px; border:1px solid #d1d5db; border-radius:6px; font-family:Heebo,sans-serif; font-size:13px; box-sizing:border-box;">
        </div>
        <div>
          <label style="font-size:11px; color:#888; display:block; margin-bottom:3px;">××¡</label>
          <input id="nf-tax" type="text" placeholder="0" style="width:100%; padding:7px 10px; border:1px solid #d1d5db; border-radius:6px; font-family:Heebo,sans-serif; font-size:13px; box-sizing:border-box;">
        </div>
        <div>
          <label style="font-size:11px; color:#888; display:block; margin-bottom:3px;">×ª××•×¨×” × ×˜×•</label>
          <input id="nf-net" type="text" placeholder="0" style="width:100%; padding:7px 10px; border:1px solid #d1d5db; border-radius:6px; font-family:Heebo,sans-serif; font-size:13px; box-sizing:border-box;">
        </div>
      </div>
      <div id="nf-fields-amount" style="display:none; margin-bottom:10px;">
        <label style="font-size:11px; color:#888; display:block; margin-bottom:3px;">×¡×›×•× (××œ×¤×™ ×©×´×—)</label>
        <input id="nf-amount" type="text" placeholder="0" style="width:200px; padding:7px 10px; border:1px solid #d1d5db; border-radius:6px; font-family:Heebo,sans-serif; font-size:13px; box-sizing:border-box;">
      </div>
      <div style="margin-bottom:10px;">
        <label style="font-size:11px; color:#888; display:block; margin-bottom:3px;">×§×™×©×•×¨ ××¡××š (iCloud)</label>
        <input id="nf-link" type="text" placeholder="https://..." style="width:100%; padding:7px 10px; border:1px solid #d1d5db; border-radius:6px; font-family:Heebo,sans-serif; font-size:13px; box-sizing:border-box;">
      </div>
      <div style="display:flex; gap:8px; justify-content:flex-start;">
        <button onclick="saveNewNote()" style="background:#1a1a2e; color:white; border:none; border-radius:8px; padding:8px 20px; font-family:Heebo,sans-serif; font-size:13px; cursor:pointer;">×©××•×¨ ×”×¢×¨×”</button>
        <button onclick="hideAddForm()" style="background:#f0f2f5; color:#555; border:none; border-radius:8px; padding:8px 16px; font-family:Heebo,sans-serif; font-size:13px; cursor:pointer;">×‘×™×˜×•×œ</button>
      </div>
    </div>
    <div style="padding:18px; overflow-y:auto; flex:1;">
      <div id="notes-list"></div>
    </div>
  </div>
</div>

<!-- CATEGORY: ××–×•××Ÿ -->
<div class="category-section" id="sec-mezuman" style="--cat-color:#0891b2;--cat-color-light:#e0f2fe;--cat-color-ultralight:#f0fbff">
  <div class="category-header" id="hdr-mezuman" onclick="toggleCat('mezuman'); selectView('mezuman')">
    <div class="cat-header-right">
      <div class="cat-icon">ğŸ’µ</div>
      <div>
        <div class="cat-name">××–×•××Ÿ</div>
        <div class="cat-count">3 ×¨×›×™×‘×™×</div>
      </div>
    </div>
    <div class="cat-header-left">
      <div class="cat-total" id="sec-val-mezuman">1,105</div>
      <div class="cat-pct" id="sec-pct-mezuman"></div>
      <div class="chevron" id="chev-mezuman">â–¼</div>
    </div>
  </div>
  <div class="category-body" id="body-mezuman">
    <table>
      <thead><tr>
        <th>×¨×›×™×‘</th>
        <th data-col="0">×™× ×•×³ 25</th><th data-col="1">×¤×‘×¨×³ 25</th><th data-col="2">××¨×¥ 25</th><th data-col="3">××¤×¨×³ 25</th><th data-col="4">×××™ 25</th><th data-col="5">×™×•× ×™ 25</th><th data-col="6">×™×•×œ×™ 25</th><th data-col="7">××•×’×³ 25</th><th data-col="8">×¡×¤×˜×³ 25</th><th data-col="9">××•×§×³ 25</th><th data-col="10">× ×•×‘×³ 25</th><th data-col="11">×“×¦××³ 25</th><th data-col="12">×™× ×•×³ 26</th><th data-col="13">×¤×‘×¨×³ 26</th>
      </tr></thead>
      <tbody>
        <tr onclick="selectFund('××–×•××Ÿ×©×§×œ×™','#0891b2')" data-fund="××–×•××Ÿ×©×§×œ×™">
          <td>××–×•××Ÿ ×©×§×œ×™</td>
          <td data-col="0" class="val">40</td><td data-col="1" class="val">40</td><td data-col="2" class="val">40</td><td data-col="3" class="val">40</td><td data-col="4" class="val">40</td><td data-col="5" class="val">40</td><td data-col="6" class="val">40</td><td data-col="7" class="val">40</td><td data-col="8" class="val">30</td><td data-col="9" class="val">20</td><td data-col="10" class="val">20</td><td data-col="11" class="val">20</td><td data-col="12" class="val">915</td><td data-col="13" class="val">100</td>
        </tr>
        <tr onclick="selectFund('××–×•××Ÿ×“×•×œ×¨×™','#0891b2')" data-fund="××–×•××Ÿ×“×•×œ×¨×™">
          <td>××–×•××Ÿ ×“×•×œ×¨×™ $</td>
          <td data-col="0" class="val">119</td><td data-col="1" class="val">106</td><td data-col="2" class="val">39</td><td data-col="3" class="val">22</td><td data-col="4" class="val">47</td><td data-col="5" class="val">50</td><td data-col="6" class="val">50</td><td data-col="7" class="val">53</td><td data-col="8" class="val">60</td><td data-col="9" class="val">161</td><td data-col="10" class="val">99</td><td data-col="11" class="val">102</td><td data-col="12" class="val">107</td><td data-col="13" class="val">104</td>
        </tr>
        <tr onclick="selectFund('××™×˜×‘×©×§×œ×™×ª','#0891b2')" data-fund="××™×˜×‘×©×§×œ×™×ª">
          <td>××™×˜×‘ ×§×¨×Ÿ ×›×¡×¤×™×ª</td>
          <td data-col="0" class="dash">â€”</td><td data-col="1" class="dash">â€”</td><td data-col="2" class="dash">â€”</td><td data-col="3" class="dash">â€”</td><td data-col="4" class="dash">â€”</td><td data-col="5" class="dash">â€”</td><td data-col="6" class="dash">â€”</td><td data-col="7" class="dash">â€”</td><td data-col="8" class="dash">â€”</td><td data-col="9" class="dash">â€”</td><td data-col="10" class="dash">â€”</td><td data-col="11" class="dash">â€”</td><td data-col="12" class="dash">â€”</td><td data-col="13" class="val">901</td>
        </tr>
        <tr class="total-row" onclick="selectView('mezuman')">
          <td>×¡×”×´×› ×§×˜×’×•×¨×™×”</td><td data-col="0" class="val">159</td><td data-col="1" class="val">146</td><td data-col="2" class="val">79</td><td data-col="3" class="val">62</td><td data-col="4" class="val">87</td><td data-col="5" class="val">90</td><td data-col="6" class="val">90</td><td data-col="7" class="val">93</td><td data-col="8" class="val">90</td><td data-col="9" class="val">181</td><td data-col="10" class="val">119</td><td data-col="11" class="val">122</td><td data-col="12" class="val">1,022</td><td data-col="13" class="val">1,105</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- CATEGORY: ×§×¨× ×•×ª ×”×©×ª×œ××•×ª -->
<div class="category-section" id="sec-hishtalmut" style="--cat-color:#dc2626;--cat-color-light:#fee2e2;--cat-color-ultralight:#fff5f5">
  <div class="category-header" id="hdr-hishtalmut" onclick="toggleCat('hishtalmut'); selectView('hishtalmut')">
    <div class="cat-header-right">
      <div class="cat-icon">ğŸ“ˆ</div>
      <div>
        <div class="cat-name">×§×¨× ×•×ª ×”×©×ª×œ××•×ª</div>
        <div class="cat-count">4 ×§×¨× ×•×ª Â· ×›×•×œ×œ ×§×¨×Ÿ ×¤×¢×™×œ×”</div>
      </div>
    </div>
    <div class="cat-header-left">
      <div class="cat-total" id="sec-val-hishtalmut">4,606</div>
      <div class="cat-pct pos" id="sec-pct-hishtalmut">+16.9%</div>
      <div class="chevron" id="chev-hishtalmut">â–¼</div>
    </div>
  </div>
  <div class="category-body" id="body-hishtalmut">
    <table>
      <thead><tr>
        <th>×§×¨×Ÿ</th>
        <th data-col="0">×™× ×•×³ 25</th><th data-col="1">×¤×‘×¨×³ 25</th><th data-col="2">××¨×¥ 25</th><th data-col="3">××¤×¨×³ 25</th><th data-col="4">×××™ 25</th><th data-col="5">×™×•× ×™ 25</th><th data-col="6">×™×•×œ×™ 25</th><th data-col="7">××•×’×³ 25</th><th data-col="8">×¡×¤×˜×³ 25</th><th data-col="9">××•×§×³ 25</th><th data-col="10">× ×•×‘×³ 25</th><th data-col="11">×“×¦××³ 25</th><th data-col="12">×™× ×•×³ 26</th><th data-col="13">×¤×‘×¨×³ 26</th>
      </tr></thead>
      <tbody>
        <tr onclick="selectFund('××©×§×”×©39905556','#dc2626')" data-fund="××©×§×”×©39905556">
          <td>××´×© ×§×´×”×© 39905556</td>
          <td data-col="0" class="val">2,406</td><td data-col="1" class="val">2,437</td><td data-col="2" class="val">2,416</td><td data-col="3" class="val">2,386</td><td data-col="4" class="val">2,401</td><td data-col="5" class="val">2,469</td><td data-col="6" class="val">2,548</td><td data-col="7" class="val">2,567</td><td data-col="8" class="val">2,595</td><td data-col="9" class="val">2,654</td><td data-col="10" class="val">2,685</td><td data-col="11" class="val">2,700</td><td data-col="12" class="val">2,700</td><td data-col="13" class="val">2,743</td>
        </tr>
        <tr onclick="selectFund('××©×§×”×©6730513','#dc2626')" data-fund="××©×§×”×©6730513">
          <td>××´×© ×§×´×”×© 6730513 â† ××™×˜×‘ 917-442504</td>
          <td data-col="0" class="val">772</td><td data-col="1" class="val">792</td><td data-col="2" class="val">770</td><td data-col="3" class="val">747</td><td data-col="4" class="val">754</td><td data-col="5" class="val">802</td><td data-col="6" class="val">846</td><td data-col="7" class="val">860</td><td data-col="8" class="val">869</td><td data-col="9" class="val">905</td><td data-col="10" class="val">919</td><td data-col="11" class="val">921</td><td data-col="12" class="val">941</td><td data-col="13" class="val">981</td>
        </tr>
        <tr onclick="selectFund('××©×§×”×©40035706','#dc2626')" data-fund="××©×§×”×©40035706">
          <td>××´×© ×§×”×´×© 40035706</td>
          <td data-col="0" class="val">281</td><td data-col="1" class="val">285</td><td data-col="2" class="val">283</td><td data-col="3" class="val">279</td><td data-col="4" class="val">281</td><td data-col="5" class="val">289</td><td data-col="6" class="val">298</td><td data-col="7" class="val">300</td><td data-col="8" class="val">304</td><td data-col="9" class="val">310</td><td data-col="10" class="val">314</td><td data-col="11" class="val">316</td><td data-col="12" class="val">316</td><td data-col="13" class="val">321</td>
        </tr>
        <tr onclick="selectFund('××•×¨×§×”×©499293','#dc2626')" data-fund="××•×¨×§×”×©499293">
          <td>××•×¨ ×§×”×´×© 499293 â† ××™×˜×‘ 917-443195 <span class="note">×¤×¢×™×œ×”</span></td>
          <td data-col="0" class="val">320</td><td data-col="1" class="val">339</td><td data-col="2" class="val">348</td><td data-col="3" class="val">350</td><td data-col="4" class="val">362</td><td data-col="5" class="val">391</td><td data-col="6" class="val">418</td><td data-col="7" class="val">435</td><td data-col="8" class="val">448</td><td data-col="9" class="val">473</td><td data-col="10" class="val">493</td><td data-col="11" class="val">508</td><td data-col="12" class="val">529</td><td data-col="13" class="val">561</td>
        </tr>
        <tr class="total-row" onclick="selectView('hishtalmut')">
          <td>×¡×”×´×› ×§×˜×’×•×¨×™×”</td>
          <td data-col="0">3,779</td><td data-col="1">3,853</td><td data-col="2">3,817</td><td data-col="3">3,762</td><td data-col="4">3,798</td><td data-col="5">3,951</td><td data-col="6">4,110</td><td data-col="7">4,162</td><td data-col="8">4,216</td><td data-col="9">4,342</td><td data-col="10">4,411</td><td data-col="11">4,445</td><td data-col="12">4,486</td><td data-col="13">4,606</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- CATEGORY: ×§×•×¤×•×ª ×’××œ -->
<div class="category-section" id="sec-gemel" style="--cat-color:#b45309;--cat-color-light:#fef3c7;--cat-color-ultralight:#fffdf5">
  <div class="category-header" id="hdr-gemel" onclick="toggleCat('gemel'); selectView('gemel')">
    <div class="cat-header-right">
      <div class="cat-icon">ğŸ¦</div>
      <div>
        <div class="cat-name">×§×•×¤×•×ª ×’××œ</div>
        <div class="cat-count">5 ×§×•×¤×•×ª Â· ×”×¤× ×™×§×¡ ×××§×•×¨ ×—×™×¦×•× ×™</div>
      </div>
    </div>
    <div class="cat-header-left">
      <div class="cat-total" id="sec-val-gemel">1,730</div>
      <div class="cat-pct pos" id="sec-pct-gemel">+17.6%</div>
      <div class="chevron" id="chev-gemel">â–¼</div>
    </div>
  </div>
  <div class="category-body" id="body-gemel">
    <table>
      <thead><tr>
        <th>×§×¨×Ÿ</th>
        <th data-col="0">×™× ×•×³ 25</th><th data-col="1">×¤×‘×¨×³ 25</th><th data-col="2">××¨×¥ 25</th><th data-col="3">××¤×¨×³ 25</th><th data-col="4">×××™ 25</th><th data-col="5">×™×•× ×™ 25</th><th data-col="6">×™×•×œ×™ 25</th><th data-col="7">××•×’×³ 25</th><th data-col="8">×¡×¤×˜×³ 25</th><th data-col="9">××•×§×³ 25</th><th data-col="10">× ×•×‘×³ 25</th><th data-col="11">×“×¦××³ 25</th><th data-col="12">×™× ×•×³ 26</th><th data-col="13">×¤×‘×¨×³ 26</th>
      </tr></thead>
      <tbody>
        <tr onclick="selectFund('6730511××©×’××œ','#b45309')" data-fund="6730511××©×’××œ">
          <td>××´×© ×’××œ 6730511 â† ××•×¨ 1428298</td>
          <td data-col="0" class="val">402</td><td data-col="1" class="val">413</td><td data-col="2" class="val">402</td><td data-col="3" class="val">391</td><td data-col="4" class="val">395</td><td data-col="5" class="val">421</td><td data-col="6" class="val">444</td><td data-col="7" class="val">452</td><td data-col="8" class="val">457</td><td data-col="9" class="val">476</td><td data-col="10" class="val">484</td><td data-col="11" class="val">490</td><td data-col="12" class="val">495</td><td data-col="13" class="val">517</td>
        </tr>
        <tr onclick="selectFund('××©×’××œ39774495','#b45309')" data-fund="××©×’××œ39774495">
          <td>××´×© ×’××œ 39774495 â† ××•×¨ 1375688</td>
          <td data-col="0" class="val">262</td><td data-col="1" class="val">266</td><td data-col="2" class="val">263</td><td data-col="3" class="val">260</td><td data-col="4" class="val">262</td><td data-col="5" class="val">269</td><td data-col="6" class="val">277</td><td data-col="7" class="val">277</td><td data-col="8" class="val">283</td><td data-col="9" class="val">289</td><td data-col="10" class="val">292</td><td data-col="11" class="val">293</td><td data-col="12" class="val">294</td><td data-col="13" class="val">300</td>
        </tr>
        <tr onclick="selectFund('6730512××©×’××œ','#b45309')" data-fund="6730512××©×’××œ">
          <td>××´×© ×’××œ 6730512 â† ××•×¨ 1375888</td>
          <td data-col="0" class="val">218</td><td data-col="1" class="val">220</td><td data-col="2" class="val">220</td><td data-col="3" class="val">220</td><td data-col="4" class="val">222</td><td data-col="5" class="val">224</td><td data-col="6" class="val">230</td><td data-col="7" class="val">231</td><td data-col="8" class="val">233</td><td data-col="9" class="val">237</td><td data-col="10" class="val">240</td><td data-col="11" class="val">242</td><td data-col="12" class="val">242</td><td data-col="13" class="val">245</td>
        </tr>
        <tr onclick="selectFund('6899425××©×’××œ','#b45309')" data-fund="6899425××©×’××œ">
          <td>××´×© ×’××œ 6899425 â† ××•×¨ 1375911</td>
          <td data-col="0" class="val">176</td><td data-col="1" class="val">180</td><td data-col="2" class="val">176</td><td data-col="3" class="val">170</td><td data-col="4" class="val">172</td><td data-col="5" class="val">183</td><td data-col="6" class="val">193</td><td data-col="7" class="val">196</td><td data-col="8" class="val">198</td><td data-col="9" class="val">206</td><td data-col="10" class="val">209</td><td data-col="11" class="val">209</td><td data-col="12" class="val">213</td><td data-col="13" class="val">223</td>
        </tr>
        <tr onclick="selectFund('×”×¤× ×™×§×¡×’××œ926-084678','#be185d')" data-fund="×”×¤× ×™×§×¡×’××œ926-084678" style="background:#fff0f6;">
          <td>×”×¤× ×™×§×¡ ×’××œ 926-084678 <span class="note">×—×™×¦×•× ×™</span></td>
          <td data-col="0" class="dash">â€”</td><td data-col="1" class="dash">â€”</td><td data-col="2" class="dash">â€”</td><td data-col="3" class="dash">â€”</td><td data-col="4" class="dash">â€”</td><td data-col="5" class="dash">â€”</td><td data-col="6" class="dash">â€”</td><td data-col="7" class="dash">â€”</td><td data-col="8" class="dash">â€”</td><td data-col="9" class="dash">â€”</td><td data-col="10" class="val">414</td><td data-col="11" class="val">414</td><td data-col="12" class="val">437</td><td data-col="13" class="val">445</td>
        </tr>
        <tr class="total-row" onclick="selectView('gemel')">
          <td>×¡×”×´×› ×§×˜×’×•×¨×™×”</td>
          <td data-col="0">1,058</td><td data-col="1">1,079</td><td data-col="2">1,061</td><td data-col="3">1,041</td><td data-col="4">1,051</td><td data-col="5">1,097</td><td data-col="6">1,144</td><td data-col="7">1,156</td><td data-col="8">1,171</td><td data-col="9">1,208</td><td data-col="10">1,639</td><td data-col="11">1,649</td><td data-col="12">1,684</td><td data-col="13">1,730</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- CATEGORY: ×’××œ ×œ×”×©×§×¢×” -->
<div class="category-section" id="sec-gemel_invest" style="--cat-color:#9f1239;--cat-color-light:#ffe4e6;--cat-color-ultralight:#fff5f6">
  <div class="category-header" id="hdr-gemel_invest" onclick="toggleCat('gemel_invest'); selectView('gemel_invest')">
    <div class="cat-header-right">
      <div class="cat-icon">ğŸ’¼</div>
      <div>
        <div class="cat-name">×’××œ ×œ×”×©×§×¢×”</div>
        <div class="cat-count">2 ×§×•×¤×•×ª Â· ×›×•×œ×œ ×”×¤×§×“×” 81k</div>
      </div>
    </div>
    <div class="cat-header-left">
      <div class="cat-total" id="sec-val-gemel_invest">902</div>
      <div class="cat-pct pos" id="sec-pct-gemel_invest">+21.8%</div>
      <div class="chevron" id="chev-gemel_invest">â–¼</div>
    </div>
  </div>
  <div class="category-body" id="body-gemel_invest">
    <table>
      <thead><tr>
        <th>×§×¨×Ÿ</th>
        <th data-col="0">×™× ×•×³ 25</th><th data-col="1">×¤×‘×¨×³ 25</th><th data-col="2">××¨×¥ 25</th><th data-col="3">××¤×¨×³ 25</th><th data-col="4">×××™ 25</th><th data-col="5">×™×•× ×™ 25</th><th data-col="6">×™×•×œ×™ 25</th><th data-col="7">××•×’×³ 25</th><th data-col="8">×¡×¤×˜×³ 25</th><th data-col="9">××•×§×³ 25</th><th data-col="10">× ×•×‘×³ 25</th><th data-col="11">×“×¦××³ 25</th><th data-col="12">×™× ×•×³ 26</th><th data-col="13">×¤×‘×¨×³ 26</th>
      </tr></thead>
      <tbody>
        <tr onclick="selectFund('××©×’××œ×œ×”×©×§×¢×”2016-1738','#9f1239')" data-fund="××©×’××œ×œ×”×©×§×¢×”2016-1738">
          <td>××´×© ×’××œ ×œ×”×©×§×¢×” â† ××™×˜×‘ 917-443197</td>
          <td data-col="0" class="val">286</td><td data-col="1" class="val">371</td><td data-col="2" class="val">368</td><td data-col="3" class="val">364</td><td data-col="4" class="val">366</td><td data-col="5" class="val">376</td><td data-col="6" class="val">389</td><td data-col="7" class="val">391</td><td data-col="8" class="val">396</td><td data-col="9" class="val">405</td><td data-col="10" class="val">410</td><td data-col="11" class="val">411</td><td data-col="12" class="val">415</td><td data-col="13" class="val">424</td>
        </tr>
        <tr onclick="selectFund('××•×¨×’××œ×œ×”×©×§×¢×”','#9f1239')" data-fund="××•×¨×’××œ×œ×”×©×§×¢×”">
          <td>××•×¨ ×’××œ ×œ×”×©×§×¢×” â† ××™×˜×‘ 912-443197</td>
          <td data-col="0" class="val">364</td><td data-col="1" class="val">376</td><td data-col="2" class="val">377</td><td data-col="3" class="val">370</td><td data-col="4" class="val">373</td><td data-col="5" class="val">393</td><td data-col="6" class="val">411</td><td data-col="7" class="val">419</td><td data-col="8" class="val">422</td><td data-col="9" class="val">436</td><td data-col="10" class="val">446</td><td data-col="11" class="val">449</td><td data-col="12" class="val">458</td><td data-col="13" class="val">478</td>
        </tr>
        <tr class="total-row" onclick="selectView('gemel_invest')">
          <td>×¡×”×´×› ×§×˜×’×•×¨×™×”</td>
          <td data-col="0">650</td><td data-col="1">747</td><td data-col="2">745</td><td data-col="3">734</td><td data-col="4">739</td><td data-col="5">769</td><td data-col="6">800</td><td data-col="7">810</td><td data-col="8">818</td><td data-col="9">841</td><td data-col="10">856</td><td data-col="11">860</td><td data-col="12">873</td><td data-col="13">902</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- CATEGORY: ×”×¨××œ + ××™×˜×‘ -->
<div class="category-section" id="sec-harel" style="margin-bottom: 20px;" style="--cat-color:#a16207;--cat-color-light:#fef9c3;--cat-color-ultralight:#fffef5">
  <div class="category-header" id="hdr-harel" onclick="toggleCat('harel'); selectView('harel')">
    <div class="cat-header-right">
      <div class="cat-icon">ğŸ›</div>
      <div>
        <div class="cat-name">×”×¨××œ</div>
        <div class="cat-count">3 ×§×¨× ×•×ª Â· ×”×¨××œ ×›×œ×œ×™ ×××§×•×¨ ×—×™×¦×•× ×™</div>
      </div>
    </div>
    <div class="cat-header-left">
      <div class="cat-total" id="sec-val-harel">7,726</div>
      <div class="cat-pct pos" id="sec-pct-harel">+11.4%</div>
      <div class="chevron" id="chev-harel">â–¼</div>
    </div>
  </div>
  <div class="category-body" id="body-harel">
    <table>
      <thead><tr>
        <th>×§×¨×Ÿ</th>
        <th data-col="0">×™× ×•×³ 25</th><th data-col="1">×¤×‘×¨×³ 25</th><th data-col="2">××¨×¥ 25</th><th data-col="3">××¤×¨×³ 25</th><th data-col="4">×××™ 25</th><th data-col="5">×™×•× ×™ 25</th><th data-col="6">×™×•×œ×™ 25</th><th data-col="7">××•×’×³ 25</th><th data-col="8">×¡×¤×˜×³ 25</th><th data-col="9">××•×§×³ 25</th><th data-col="10">× ×•×‘×³ 25</th><th data-col="11">×“×¦××³ 25</th><th data-col="12">×™× ×•×³ 26</th><th data-col="13">×¤×‘×¨×³ 26</th>
      </tr></thead>
      <tbody>
        <tr onclick="selectFund('×”×¨××œ××’×•×•×Ÿ-×¤×•×œ×™×¡×ª×—×™×¡×›','#a16207')" data-fund="×”×¨××œ××’×•×•×Ÿ-×¤×•×œ×™×¡×ª×—×™×¡×›">
          <td>×”×¨××œ ××’×•×•×Ÿ - ×¤×•×œ×™×¡×ª ×—×™×¡×›×•×Ÿ</td>
          <td data-col="0" class="val">4,469</td><td data-col="1" class="val">4,473</td><td data-col="2" class="val">4,440</td><td data-col="3" class="val">4,444</td><td data-col="4" class="val">4,536</td><td data-col="5" class="val">4,630</td><td data-col="6" class="val">4,704</td><td data-col="7" class="val">4,758</td><td data-col="8" class="val">4,810</td><td data-col="9" class="val">4,927</td><td data-col="10" class="val">4,949</td><td data-col="11" class="val">5,019</td><td data-col="12" class="val">5,119</td><td data-col="13" class="val">5,174</td>
        </tr>
        <tr onclick="selectFund('×”×¨××œ×× ×™×•×ª106863031','#a16207')" data-fund="×”×¨××œ×× ×™×•×ª106863031">
          <td>×”×¨××œ ×× ×™×•×ª 106863031</td>
          <td data-col="0" class="val">1,680</td><td data-col="1" class="val">1,631</td><td data-col="2" class="val">1,572</td><td data-col="3" class="val">1,515</td><td data-col="4" class="val">1,620</td><td data-col="5" class="val">1,655</td><td data-col="6" class="val">1,703</td><td data-col="7" class="val">1,732</td><td data-col="8" class="val">1,799</td><td data-col="9" class="val">1,828</td><td data-col="10" class="val">1,775</td><td data-col="11" class="val">1,768</td><td data-col="12" class="val">1,766</td><td data-col="13" class="val">1,664</td>
        </tr>
        <tr onclick="selectFund('×”×¨××œ×›×œ×œ×™109062745','#a16207')" data-fund="×”×¨××œ×›×œ×œ×™109062745">
          <td>×”×¨××œ ×›×œ×œ×™ 109062745 <span class="note">×—×™×¦×•× ×™</span></td>
          <td data-col="0" class="dash">â€”</td><td data-col="1" class="dash">â€”</td><td data-col="2" class="dash">â€”</td><td data-col="3" class="dash">â€”</td><td data-col="4" class="val">252</td><td data-col="5" class="val">258</td><td data-col="6" class="val">262</td><td data-col="7" class="val">265</td><td data-col="8" class="val">268</td><td data-col="9" class="val">274</td><td data-col="10" class="val">275</td><td data-col="11" class="val">279</td><td data-col="12" class="val">285</td><td data-col="13" class="val">288</td>
        </tr>

        <tr class="total-row" onclick="selectView('harel')">
          <td>×¡×”×´×› ×§×˜×’×•×¨×™×”</td>
          <td data-col="0">6,149</td><td data-col="1">6,104</td><td data-col="2">6,012</td><td data-col="3">5,959</td><td data-col="4">6,408</td><td data-col="5">6,543</td><td data-col="6">6,669</td><td data-col="7">6,755</td><td data-col="8">6,877</td><td data-col="9">7,029</td><td data-col="10">6,999</td><td data-col="11">7,066</td><td data-col="12">7,199</td><td data-col="13">7,126</td>
        </tr>
      </tbody>
    </table>
  </div>

<!-- CATEGORY: ××™×˜×‘ ×§×¨× ×•×ª -->
<div style="margin-top: 8px;"></div>
<div class="category-section" id="sec-meitav" style="margin-top: 20px; --cat-color:#7c3aed;--cat-color-light:#ede9fe;--cat-color-ultralight:#f8f7ff">
  <div class="category-header" id="hdr-meitav" onclick="toggleCat('meitav'); selectView('meitav')">
    <div class="cat-header-right">
      <div class="cat-icon">ğŸ“Š</div>
      <div>
        <div class="cat-name">××™×˜×‘</div>
        <div class="cat-count">2 ×§×¨× ×•×ª</div>
      </div>
    </div>
    <div class="cat-header-left">
      <div class="cat-total" id="sec-val-meitav">600</div>
      <div class="cat-pct pos" id="sec-pct-meitav">+13.2%</div>
      <div class="chevron" id="chev-meitav">â–¼</div>
    </div>
  </div>
  <div class="category-body" id="body-meitav">
    <table>
      <thead><tr>
        <th>×§×¨×Ÿ</th>
        <th data-col="0">×™× ×•×³ 25</th><th data-col="1">×¤×‘×¨×³ 25</th><th data-col="2">××¨×¥ 25</th><th data-col="3">××¤×¨×³ 25</th><th data-col="4">×××™ 25</th><th data-col="5">×™×•× ×™ 25</th><th data-col="6">×™×•×œ×™ 25</th><th data-col="7">××•×’×³ 25</th><th data-col="8">×¡×¤×˜×³ 25</th><th data-col="9">××•×§×³ 25</th><th data-col="10">× ×•×‘×³ 25</th><th data-col="11">×“×¦××³ 25</th><th data-col="12">×™× ×•×³ 26</th><th data-col="13">×¤×‘×¨×³ 26</th>
      </tr></thead>
      <tbody>
        <tr onclick="selectFund('××™×˜×‘×“×©× ×™×”×•×œ×§×¨× ×•×ª1693','#7c3aed')" data-fund="××™×˜×‘×“×©× ×™×”×•×œ×§×¨× ×•×ª1693">
          <td>××™×˜×‘ ×“×© × ×™×”×•×œ ×§×¨× ×•×ª 169301968</td>
          <td data-col="0" class="val">530</td><td data-col="1" class="val">530</td><td data-col="2" class="val">527</td><td data-col="3" class="val">520</td><td data-col="4" class="val">540</td><td data-col="5" class="val">550</td><td data-col="6" class="val">560</td><td data-col="7" class="val">560</td><td data-col="8" class="val">560</td><td data-col="9" class="val">560</td><td data-col="10" class="val">580</td><td data-col="11" class="val">580</td><td data-col="12" class="val">580</td><td data-col="13" class="val">600</td>
        </tr>
        <tr onclick="selectFund('××™×˜×‘×“×©×˜×¨×™×™×“','#7c3aed')" data-fund="××™×˜×‘×“×©×˜×¨×™×™×“">
          <td>××™×˜×‘ ×“×© ×˜×¨×™×™×“</td><td data-col="0" class="val">39</td><td data-col="1" class="val">39</td><td data-col="2" class="val">39</td><td data-col="3" class="val">39</td><td data-col="4" class="val">39</td><td data-col="5" class="val">39</td><td data-col="6" class="val">39</td><td data-col="7" class="val">39</td><td data-col="8" class="val">39</td><td data-col="9" class="val">39</td><td data-col="10" class="val">39</td><td data-col="11" class="val">39</td><td data-col="12" class="val">39</td><td data-col="13" class="val">39</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

</div>
<!-- CATEGORY: ××¨×‘×™×˜×¨××–×³ ×•××œ×™×• -->
<div class="category-section" id="sec-arbitrage" style="--cat-color:#7c3aed;--cat-color-light:#ede9fe;--cat-color-ultralight:#f8f7ff">
  <div class="category-header" id="hdr-arbitrage" onclick="toggleCat('arbitrage'); selectView('arbitrage')">
    <div class="cat-header-right">
      <div class="cat-icon">ğŸ“Š</div>
      <div>
        <div class="cat-name">××¨×‘×™×˜×¨××–×³ ×•××œ×™×•</div>
        <div class="cat-count">×§×¨×Ÿ ××—×ª Â· × ××›×¨×” ×™× ×•×³ 26</div>
      </div>
    </div>
    <div class="cat-header-left">
      <div class="cat-total" id="sec-val-arbitrage">0</div>
      <div class="cat-pct" id="sec-pct-arbitrage"></div>
      <div class="chevron" id="chev-arbitrage">â–¼</div>
    </div>
  </div>
  <div class="category-body" id="body-arbitrage">
    <table>
      <thead><tr>
        <th>×§×¨×Ÿ</th>
        <th data-col="0">×™× ×•×³ 25</th><th data-col="1">×¤×‘×¨×³ 25</th><th data-col="2">××¨×¥ 25</th><th data-col="3">××¤×¨×³ 25</th><th data-col="4">×××™ 25</th><th data-col="5">×™×•× ×™ 25</th><th data-col="6">×™×•×œ×™ 25</th><th data-col="7">××•×’×³ 25</th><th data-col="8">×¡×¤×˜×³ 25</th><th data-col="9">××•×§×³ 25</th><th data-col="10">× ×•×‘×³ 25</th><th data-col="11">×“×¦××³ 25</th><th data-col="12">×™× ×•×³ 26</th><th data-col="13">×¤×‘×¨×³ 26</th>
      </tr></thead>
      <tbody>
        <tr onclick="selectFund('××¨×‘×™×˜×¨××–×•××œ×™×•','#7c3aed')" data-fund="××¨×‘×™×˜×¨××–×•××œ×™×•">
          <td>××¨×‘×™×˜×¨××–×³ ×•××œ×™×•</td><td data-col="0" class="val">719</td><td data-col="1" class="val">822</td><td data-col="2" class="val">824</td><td data-col="3" class="val">772</td><td data-col="4" class="val">808</td><td data-col="5" class="val">846</td><td data-col="6" class="val">902</td><td data-col="7" class="val">900</td><td data-col="8" class="val">895</td><td data-col="9" class="val">895</td><td data-col="10" class="val">886</td><td data-col="11" class="val">901</td><td data-col="12">0</td><td data-col="13">0</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- CATEGORY: ×“×™×¨×” -->
<div class="category-section" id="sec-dira" style="--cat-color:#78716c;--cat-color-light:#f5f5f4;--cat-color-ultralight:#fafaf9">
  <div class="category-header" id="hdr-dira" onclick="selectView('dira')" style="cursor:pointer;">
    <div class="cat-header-right">
      <div class="cat-icon">ğŸ </div>
      <div>
        <div class="cat-name">×“×™×¨×”</div>
        <div class="cat-count">×¢×¨×š ×§×‘×•×¢ ×‘×¡×¤×¨×™×</div>
      </div>
    </div>
    <div class="cat-header-left">
      <div class="cat-total" id="sec-val-dira">1,200</div>
      <div class="cat-pct" id="sec-pct-dira"></div>
    </div>
  </div>
</div>

<!-- CATEGORY: ×—×•×‘ -->
<div class="category-section" id="sec-chov" style="--cat-color:#64748b;--cat-color-light:#f1f5f9;--cat-color-ultralight:#f8fafc">
  <div class="category-header" id="hdr-chov" onclick="toggleCat('chov'); selectView('chov')">
    <div class="cat-header-right">
      <div class="cat-icon">ğŸ“‰</div>
      <div>
        <div class="cat-name">×—×•×‘</div>
        <div class="cat-count">2 ×¨×›×™×‘×™× Â· ×¦×¤×•×™ ×œ×”×ª××¤×¡</div>
      </div>
    </div>
    <div class="cat-header-left">
      <div class="cat-total" id="sec-val-chov" style="color:#ef4444;">1,768 </div>
      <div class="cat-pct" id="sec-pct-chov"></div>
      <div class="chevron" id="chev-chov">â–¼</div>
    </div>
  </div>
  <div class="category-body" id="body-chov">
    <table>
      <thead><tr>
        <th>×¨×›×™×‘</th>
        <th data-col="0">×™× ×•×³ 25</th><th data-col="1">×¤×‘×¨×³ 25</th><th data-col="2">××¨×¥ 25</th><th data-col="3">××¤×¨×³ 25</th><th data-col="4">×××™ 25</th><th data-col="5">×™×•× ×™ 25</th><th data-col="6">×™×•×œ×™ 25</th><th data-col="7">××•×’×³ 25</th><th data-col="8">×¡×¤×˜×³ 25</th><th data-col="9">××•×§×³ 25</th><th data-col="10">× ×•×‘×³ 25</th><th data-col="11">×“×¦××³ 25</th><th data-col="12">×™× ×•×³ 26</th><th data-col="13">×¤×‘×¨×³ 26</th>
      </tr></thead>
      <tbody>
        <tr onclick="selectFund('×—×•×‘×”×¨××œ','#64748b')" data-fund="×—×•×‘×”×¨××œ">
          <td>×—×•×‘ ×”×¨××œ</td><td data-col="0" class="val">195 </td><td data-col="1" class="val">179 </td><td data-col="2" class="val">165 </td><td data-col="3" class="val">150 </td><td data-col="4" class="val">135 </td><td data-col="5" class="val">120 </td><td data-col="6" class="val">105 </td><td data-col="7" class="val">90 </td><td data-col="8" class="val">75 </td><td data-col="9" class="val">60 </td><td data-col="10" class="val">45 </td><td data-col="11" class="val">30 </td><td data-col="12" class="val">15 </td><td data-col="13" class="dzer">0</td>
        </tr>
        <tr onclick="selectFund('×—×•×‘××œ×˜×©×•×œ×¨','#64748b')" data-fund="×—×•×‘××œ×˜×©×•×œ×¨">
          <td>×—×•×‘ ××œ×˜×©×•×œ×¨</td><td data-col="0" class="val">1,667 </td><td data-col="1" class="val">1,674 </td><td data-col="2" class="val">1,681 </td><td data-col="3" class="val">1,681 </td><td data-col="4" class="val">1,696 </td><td data-col="5" class="val">1,708 </td><td data-col="6" class="val">1,718 </td><td data-col="7" class="val">1,727 </td><td data-col="8" class="val">1,735 </td><td data-col="9" class="val">1,743 </td><td data-col="10" class="val">1,750 </td><td data-col="11" class="val">1,756 </td><td data-col="12" class="val">1,765 </td><td data-col="13" class="val">1,768 </td>
        </tr>
        <tr class="total-row" onclick="selectView('chov')">
          <td>×¡×”×´×› ×—×•×‘</td><td data-col="0" class="val">1,862 </td><td data-col="1" class="val">1,853 </td><td data-col="2" class="val">1,846 </td><td data-col="3" class="val">1,831 </td><td data-col="4" class="val">1,831 </td><td data-col="5" class="val">1,828 </td><td data-col="6" class="val">1,823 </td><td data-col="7" class="val">1,817 </td><td data-col="8" class="val">1,810 </td><td data-col="9" class="val">1,803 </td><td data-col="10" class="val">1,795 </td><td data-col="11" class="val">1,786 </td><td data-col="12" class="val">1,780 </td><td data-col="13" class="val">1,768 </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<script>
const LABELS = ['×™× ×•×³ 25','×¤×‘×¨×³ 25','××¨×¥ 25','××¤×¨×³ 25','×××™ 25','×™×•× ×™ 25','×™×•×œ×™ 25','××•×’×³ 25','×¡×¤×˜×³ 25','××•×§×³ 25','× ×•×‘×³ 25','×“×¦××³ 25','×™× ×•×³ 26','×¤×‘×¨×³ 26'];

const FUNDS = {
  '××©×§×”×©39905556':       { name:'××´×© ×§×´×”×© 39905556',      cat:'hishtalmut', data:[2406,2437,2416,2386,2401,2469,2548,2567,2595,2654,2685,2700,2700,2743] },
  '××©×§×”×©6730513':        { name:'××´×© ×§×´×”×© 6730513 â† ××™×˜×‘ 442504', cat:'hishtalmut', data:[772,792,770,747,754,802,846,860,869,905,919,921,941,981] },
  '××©×§×”×©40035706':       { name:'××´×© ×§×”×´×© 40035706',       cat:'hishtalmut', data:[281,285,283,279,281,289,298,300,304,310,314,316,316,321] },
  '××•×¨×§×”×©499293':        { name:'××•×¨ ×§×”×´×© 499293 â† ××™×˜×‘ 443195', cat:'hishtalmut', data:[320,339,348,350,362,391,418,435,448,473,493,508,529,561] },

  '6730511××©×’××œ':        { name:'××´×© ×’××œ 6730511 â† ××•×¨ 1428298', cat:'gemel', data:[402,413,402,391,395,421,444,452,457,476,484,490,495,517] },
  '××©×’××œ39774495':       { name:'××´×© ×’××œ 39774495 â† ××•×¨ 1375688', cat:'gemel', data:[262,266,263,260,262,269,277,277,283,289,292,293,294,300] },
  '6730512××©×’××œ':        { name:'××´×© ×’××œ 6730512 â† ××•×¨ 1375888', cat:'gemel', data:[218,220,220,220,222,224,230,231,233,237,240,242,242,245] },
  '6899425××©×’××œ':        { name:'××´×© ×’××œ 6899425 â† ××•×¨ 1375911', cat:'gemel', data:[176,180,176,170,172,183,193,196,198,206,209,209,213,223] },
  '×”×¤× ×™×§×¡×’××œ926-084678': { name:'×”×¤× ×™×§×¡ ×’××œ 926-084678',   cat:'gemel', data:[null,null,null,null,null,null,null,null,null,null,414,414,437,445] },
  '××©×’××œ×œ×”×©×§×¢×”2016-1738':{ name:'××´×© ×’××œ ×œ×”×©×§×¢×” â† ××™×˜×‘ 917-443197', cat:'gemel_invest', data:[286,371,368,364,366,376,389,391,396,405,410,411,415,424] },
  '××•×¨×’××œ×œ×”×©×§×¢×”':        { name:'××•×¨ ×’××œ ×œ×”×©×§×¢×” â† ××™×˜×‘ 912-443197', cat:'gemel_invest', data:[364,376,377,370,373,393,411,419,422,436,446,449,458,478] },
  '×”×¨××œ××’×•×•×Ÿ-×¤×•×œ×™×¡×ª×—×™×¡×›':{ name:'×”×¨××œ ××’×•×•×Ÿ - ×¤×•×œ×™×¡×ª ×—×™×¡×›×•×Ÿ', cat:'harel', data:[4469,4473,4440,4444,4536,4630,4704,4758,4810,4927,4949,5019,5119,5174] },
  '×”×¨××œ×× ×™×•×ª106863031':  { name:'×”×¨××œ ×× ×™×•×ª 106863031',    cat:'harel', data:[1680,1631,1572,1515,1620,1655,1703,1732,1799,1828,1775,1768,1766,1664] },
  '×”×¨××œ×›×œ×œ×™109062745':   { name:'×”×¨××œ ×›×œ×œ×™ 109062745',     cat:'harel', data:[null,null,null,null,252,258,262,265,268,274,275,279,285,288] },
  '××™×˜×‘×“×©× ×™×”×•×œ×§×¨× ×•×ª1693':{ name:'××™×˜×‘ ×“×© × ×™×”×•×œ ×§×¨× ×•×ª 169301968', cat:'meitav', data:[530,530,527,520,540,550,560,560,560,560,580,580,580,600] },
  '××™×˜×‘×“×©×˜×¨×™×™×“': { name:'××™×˜×‘ ×“×© ×˜×¨×™×™×“', cat:'meitav', data:[39,39,39,39,39,39,39,39,39,39,39,39,39,39] },
  '×—×•×‘×”×¨××œ':   { name:'×—×•×‘ ×”×¨××œ',       cat:'chov', data:[195,179,165,150,135,120,105,90,75,60,45,30,15,0] },
  '×—×•×‘××œ×˜×©×•×œ×¨':{ name:'×—×•×‘ ××œ×˜×©×•×œ×¨',    cat:'chov', data:[1667,1674,1681,1681,1696,1708,1718,1727,1735,1743,1750,1756,1765,1768] },
  '××¨×‘×™×˜×¨××–×•××œ×™×•': { name:'××¨×‘×™×˜×¨××–×³ ×•××œ×™×•', cat:'arbitrage', data:[719,822,824,772,808,846,902,900,895,895,886,901,0,0] },
  '×“×™×¨×”': { name:'×“×™×¨×”', cat:'dira', data:[1200,1200,1200,1200,1200,1200,1200,1200,1200,1200,1200,1200,1200,1200] },
  '××–×•××Ÿ×©×§×œ×™':   { name:'××–×•××Ÿ ×©×§×œ×™',   cat:'mezuman', data:[40,40,40,40,40,40,40,40,30,20,20,20,915,100] },
  '××–×•××Ÿ×“×•×œ×¨×™':  { name:'××–×•××Ÿ ×“×•×œ×¨×™ $', cat:'mezuman', data:[null,null,null,null,null,null,null,null,null,null,null,null,null,115] },
  '××™×˜×‘×©×§×œ×™×ª':   { name:'××™×˜×‘ ×§×¨×Ÿ ×›×¡×¤×™×ª', cat:'mezuman', data:[0,0,0,0,0,0,0,0,0,0,0,0,0,901] },
};

const CAT_COLORS = { mezuman:'#0891b2', chov:'#64748b', arbitrage:'#7c3aed', dira:'#78716c', hishtalmut:'#dc2626', gemel:'#b45309', gemel_invest:'#9f1239', harel:'#a16207', meitav:'#7c3aed', all:'#1a1a2e' };
const CAT_NAMES  = { mezuman:'××–×•××Ÿ', chov:'×—×•×‘', arbitrage:'××¨×‘×™×˜×¨××–×³ ×•××œ×™×•', dira:'×“×™×¨×”', hishtalmut:'×§×¨× ×•×ª ×”×©×ª×œ××•×ª', gemel:'×§×•×¤×•×ª ×’××œ', gemel_invest:'×’××œ ×œ×”×©×§×¢×”', harel:'×”×¨××œ', meitav:'××™×˜×‘', all:'×¡×”×´×› ×›×œ ×”×§×˜×’×•×¨×™×•×ª' };

// Category totals (for table display - includes all funds)
const CAT_TOTALS = { mezuman:[], chov:[], arbitrage:[], dira:[], hishtalmut:[], gemel:[], gemel_invest:[], harel:[], meitav:[] };
LABELS.forEach((_, i) => {
  Object.entries(CAT_TOTALS).forEach(([cat, arr]) => {
    const vals = Object.values(FUNDS).filter(f => f.cat===cat).map(f => f.data[i]||0);
    arr.push(vals.reduce((a,b)=>a+b,0));
  });
});

// Category chart totals (for chart - excludes fund value after it reaches 0)
function buildCatChartTotals() {
  // Same as CAT_TOTALS - show actual values including sold funds as 0
  const totals = { mezuman:[], chov:[], arbitrage:[], dira:[], hishtalmut:[], gemel:[], gemel_invest:[], harel:[], meitav:[] };
  LABELS.forEach((_, i) => {
    Object.entries(totals).forEach(([cat, arr]) => {
      const vals = Object.values(FUNDS).filter(f => f.cat===cat).map(f => f.data[i]||0);
      arr.push(vals.reduce((a,b)=>a+b,0));
    });
  });
  return totals;
}
let CAT_CHART_TOTALS = buildCatChartTotals();
const ALL_TOTALS = LABELS.map((_,i) => {
  let t = 0;
  Object.entries(CAT_TOTALS).forEach(([cat, arr]) => { t += cat === 'chov' ? -(arr[i]||0) : (arr[i]||0); });
  return t;
});

const WINDOW = 13;
let winStart = Math.max(0, LABELS.length - WINDOW);

function getWindow(data) {
  return { labels: LABELS.slice(winStart, winStart + WINDOW), data: data.slice(winStart, winStart + WINDOW) };
}

const ctx = document.getElementById('mainChart').getContext('2d');
let currentData = ALL_TOTALS;

// Sold fund annotation plugin
const soldAnnotationPlugin = {
  id: 'soldAnnotation',
  afterDraw(ch) {
    const ann = ch._soldAnnotations;
    if (!ann || !ann.length) return;
    const ctx2 = ch.ctx;
    const meta = ch.getDatasetMeta(0);
    ann.forEach(a => {
      const pt = meta.data[a.winIdx];
      if (!pt) return;
      ctx2.save();
      // Draw red dot
      ctx2.beginPath();
      ctx2.arc(pt.x, pt.y, 6, 0, 2 * Math.PI);
      ctx2.fillStyle = '#ef4444';
      ctx2.fill();
      // Draw label with white background
      const txt = 'â¬‡ ××›×™×¨×” | ' + a.value;
      ctx2.font = 'bold 11px Heebo,sans-serif';
      ctx2.textAlign = 'right';
      ctx2.direction = 'rtl';
      const txtW = ctx2.measureText(txt).width;
      const tx = pt.x + 4, ty = pt.y - 14;
      ctx2.fillStyle = 'rgba(255,255,255,0.85)';
      ctx2.fillRect(tx - txtW - 4, ty - 12, txtW + 8, 16);
      ctx2.fillStyle = '#dc2626';
      ctx2.fillText(txt, tx + txtW - 2, ty);
      ctx2.restore();
    });
  }
};
Chart.register(soldAnnotationPlugin);

let chart = new Chart(ctx, {
  type: 'line',
  data: {
    labels: getWindow(ALL_TOTALS).labels,
    datasets: [{
      label: '×¡×”×´×›',
      data: getWindow(ALL_TOTALS).data,
      borderColor: '#1a1a2e',
      backgroundColor: 'rgba(26,26,46,0.07)',
      borderWidth: 2.5,
      pointRadius: 5,
      pointHoverRadius: 7,
      pointBackgroundColor: '#1a1a2e',
      tension: 0.4,
      fill: true,
    }]
  },
  options: {
    responsive: true, maintainAspectRatio: false,
    plugins: {
      legend: { display: false },
      tooltip: {
        rtl: true, textDirection: 'rtl',
        callbacks: {
          label: c => {
            const val = ` ${Math.round(c.parsed.y).toLocaleString()} ××œ×£`;
            // Check if any fund in current category was sold at this point
            if (currentView && currentView !== 'all') {
              const colIdx = c.dataIndex;
              const soldFunds = Object.values(FUNDS).filter(f => {
                if (f.cat !== currentView) return false;
                let wasActive = false;
                for (let i = 0; i < f.data.length; i++) {
                  if ((f.data[i]||0) > 0) wasActive = true;
                  else if (wasActive && i === colIdx) return true;
                }
                return false;
              });
              if (soldFunds.length > 0) {
                return [val, 'âš ï¸ ×›×•×œ×œ ××›×™×¨×ª: ' + soldFunds.map(f=>f.name).join(', ')];
              }
            }
            return val;
          }
        }
      }
    },
    scales: {
      x: { grid: { display: true, color:'#f0f0f0' }, ticks: { font: { family:'Heebo', size:11 } } },
      y: { grid: { color:'#f0f0f0' }, ticks: { callback: v=>v.toLocaleString(), font:{ family:'Heebo', size:11 } }, grace: '15%', beginAtZero: false }
    },
    animation: { duration: 300 }
  }
})
window.addEventListener('resize', () => { if(chart) chart.resize(); });
setTimeout(() => { if(chart) chart.resize(); }, 100);

// Base Jan 2025 values for % calculations
const BASE = {
  mezuman: 0, // ×œ× × ××“×“
  hishtalmut: 3459, // excluding active fund
  gemel: 1058,
  gemel_invest: 731, // 650 + ×”×¤×§×“×” 81k (×¤×‘×¨' 2025)
  harel: 6149, // 6679 - 530 (××™×˜×‘)
  meitav: 569, // 530 ××™×˜×‘ ×§×¨× ×•×ª + 39 ×˜×¨×™×™×“
};
// Funds excluded from % (external/active) per category
const EXCLUDE_FROM_PCT = {
  mezuman: [],
  hishtalmut: ['××•×¨×§×”×©499293'],
  gemel: ['×”×¤× ×™×§×¡×’××œ926-084678'],
  gemel_invest: [],
  harel: ['×”×¨××œ×›×œ×œ×™109062745'],
  meitav: [],
};

function getCatTotal(cat, idx) {
  return Object.values(FUNDS).filter(f => f.cat===cat).reduce((s,f) => s+(f.data[idx]||0), 0);
}
function getCatMeasured(cat, idx) {
  const excl = EXCLUDE_FROM_PCT[cat] || [];
  return Object.entries(FUNDS)
    .filter(([k,f]) => f.cat===cat && !excl.includes(k) && (f.data[idx]||0) > 0)
    .reduce((s,[,f]) => s+(f.data[idx]||0), 0);
}

function getCatBase(cat, idx) {
  // Base: only funds that are active (>0) at the end index
  const excl = EXCLUDE_FROM_PCT[cat] || [];
  return Object.entries(FUNDS)
    .filter(([k,f]) => f.cat===cat && !excl.includes(k) && (f.data[idx]||0) > 0)
    .reduce((s,[,f]) => s+(f.data[idx]||0), 0);
}

function updateDynamicStats() {
  const endIdx = Math.min(winStart + WINDOW - 1, LABELS.length - 1);
  const cats = ['mezuman','hishtalmut','gemel','gemel_invest','harel','meitav','arbitrage','dira','chov'];
  const el = id => document.getElementById(id);
  const endLabel = LABELS[endIdx];

  const catTotals = {}, catMeasured = {};
  cats.forEach(cat => {
    catTotals[cat] = 0;
    catMeasured[cat] = 0;
    const excl = EXCLUDE_FROM_PCT[cat] || [];
    Object.entries(FUNDS).forEach(([k, f]) => {
      if (f.cat !== cat) return;
      const v = f.data[endIdx] || 0;
      catTotals[cat] += v;
      if (!excl.includes(k) && v > 0) catMeasured[cat] += v;
    });
  });

  const grandTotal = cats.reduce((s,c) => c === 'chov' ? s - catTotals[c] : s + catTotals[c], 0);
  const noPctCats = ['mezuman','chov','arbitrage','dira'];
  const startIdx = winStart;
  const startLabel = LABELS[startIdx];

  const grandMeasured = cats.reduce((s,c) => noPctCats.includes(c) ? s : s + catMeasured[c], 0);
  const grandMeasuredStart = cats.reduce((s,c) => {
    if(noPctCats.includes(c)) return s;
    const excl = EXCLUDE_FROM_PCT[c]||[];
    // Only include funds active (>0) at endIdx in the base calculation
    return s + Object.entries(FUNDS)
      .filter(([k,f])=>f.cat===c && !excl.includes(k) && (f.data[endIdx]||0)>0)
      .reduce((a,[,f])=>a+(f.data[startIdx]||0),0);
  }, 0);
  const grandBase = grandMeasuredStart > 0 ? grandMeasuredStart : cats.reduce((s,c) => noPctCats.includes(c) ? s : s + (BASE[c]||0), 0);
  const grandBase0 = cats.reduce((s,c) => {
    const v = Object.entries(FUNDS).filter(([k,f])=>f.cat===c).reduce((a,[k,f])=>a+(f.data[startIdx]||0),0);
    return c === 'chov' ? s - v : s + v;
  }, 0);
  const grandPct = ((grandMeasured - grandBase) / grandBase * 100).toFixed(1);
  const grandDiff = grandTotal - grandBase0;

  if(el('hdr-total')) el('hdr-total').textContent = '' + Math.round(grandTotal).toLocaleString();
  // Middle stat: total change + breakdown
  if(el('hdr-change-val')) {
    const v = Math.round(grandDiff);
    el('hdr-change-val').textContent = (v<0?'-':'') + Math.abs(v).toLocaleString();
    el('hdr-change-val').style.color = v<0 ? '#ef4444' : '#4ade80';
  }
  const knownDeposits = 1682; // 81k ×’××œ + 414k ×¤× ×™×§×¡ + 286k ×”×¨××œ ×›×œ×œ×™ + 901k ×§×¨×Ÿ ×›×¡×¤×™×ª
  const returnsAmt = Math.round(grandDiff) - knownDeposits;
  if(el('hdr-returns-val')) {
    el('hdr-returns-val').textContent = (returnsAmt<0?'-':'') + Math.abs(returnsAmt).toLocaleString();
    el('hdr-returns-val').style.color = returnsAmt<0 ? '#ef4444' : 'white';
  }
  if(el('hdr-deposits-val')) el('hdr-deposits-val').textContent = knownDeposits.toLocaleString();
  // Right stat: measured return %
  if(el('hdr-ret-val')) {
    el('hdr-ret-val').textContent = (parseFloat(grandPct)<0?'-':'') + Math.abs(parseFloat(grandPct)).toFixed(1) + '%';
    el('hdr-ret-val').style.color = parseFloat(grandPct)<0 ? '#ef4444' : '#4ade80';
  }
  if(el('hdr-ret-range')) el('hdr-ret-range').textContent = startLabel + ' â€“ ' + endLabel;
  // Subtitle in red
  const headerSub = document.getElementById('hdr-subtitle');
  if(headerSub) { headerSub.textContent = '××¦×™×’: ' + endLabel; }

  if(el('card-val-all')) el('card-val-all').textContent = '' + Math.round(grandTotal).toLocaleString();
  if(el('card-chg-all')) el('card-chg-all').textContent = (grandPct>=0?'+':'') + grandPct + '% × ××“×“';

  cats.forEach(cat => {
    const noPct = ['mezuman','chov','arbitrage','dira'];
    const total = Math.round(Math.abs(catTotals[cat])).toLocaleString();
    if(el('card-val-'+cat)) el('card-val-'+cat).textContent = total;
    if(el('sec-val-'+cat)) {
      el('sec-val-'+cat).textContent = total;
      if(cat==='chov') el('sec-val-'+cat).style.color='#ef4444';
    }
    if (noPct.includes(cat)) {
      if(el('card-chg-'+cat)) { el('card-chg-'+cat).textContent=''; }
      if(el('sec-pct-'+cat)) { el('sec-pct-'+cat).textContent=''; el('sec-pct-'+cat).className='cat-pct'; }
      return;
    }
    // Dynamic base: only funds active (>0) at endIdx
    const excl = EXCLUDE_FROM_PCT[cat] || [];
    const dynamicBase = Object.entries(FUNDS)
      .filter(([k,f]) => f.cat===cat && !excl.includes(k) && (f.data[endIdx]||0) > 0)
      .reduce((s,[,f]) => s + (f.data[startIdx]||0), 0);
    if (dynamicBase === 0) return;
    const pct = ((catMeasured[cat] - dynamicBase) / dynamicBase * 100).toFixed(1);
    const sign = pct >= 0 ? '+' : '';
    const arrow = pct >= 0 ? 'â–²' : 'â–¼';
    if(el('card-chg-'+cat)) el('card-chg-'+cat).textContent = arrow + ' ' + sign + pct + '%';
    if(el('sec-pct-'+cat)) {
      el('sec-pct-'+cat).textContent = sign + pct + '%';
      el('sec-pct-'+cat).className = 'cat-pct ' + (parseFloat(pct) >= 0 ? 'pos' : 'neg');
    }
  });
}
function updateNavButtons() {
  document.getElementById('btnPrev').disabled = winStart <= 0;
  document.getElementById('btnNext').disabled = winStart + WINDOW >= LABELS.length;
  const from = LABELS[winStart];
  const to = LABELS[Math.min(winStart + WINDOW - 1, LABELS.length - 1)];
  document.getElementById('winRange').textContent = to + ' â€“ ' + from;
  syncTableScroll();
  updateDynamicStats();
}

function syncTableScroll() {
  // Show only columns winStart to winStart+WINDOW-1
  const visStart = winStart;
  const visEnd = winStart + WINDOW - 1;
  document.querySelectorAll('[data-col]').forEach(el => {
    const col = parseInt(el.getAttribute('data-col'));
    el.style.display = (col >= visStart && col <= visEnd) ? '' : 'none';
  });
}

function slideWindow(dir) {
  winStart = Math.max(0, Math.min(winStart + dir, LABELS.length - WINDOW));
  const w = getWindow(currentData);
  chart.data.labels = w.labels;
  chart.data.datasets[0].data = w.data;
  chart.update();
  updateNavButtons();
  updateChartStats(currentData, currentView);
}

let currentView = 'all';
let currentFund = null;

function updateChartStats(data, viewCat) {
  const w = getWindow(data);
  const validData = w.data.filter(v => v != null && !isNaN(v));
  const growthEl = document.getElementById('chart-growth');
  const returnEl = document.getElementById('chart-return');
  const growthLabel = growthEl.previousElementSibling;
  const returnLabel = returnEl.previousElementSibling;

  if(validData.length === 0) {
    document.getElementById('chart-accum').textContent = 'â€”';
    growthEl.textContent = 'â€”';
    returnEl.textContent = 'â€”';
    return;
  }
  const last = validData[validData.length - 1];
  const first = validData[0];
  const growth = last - first;

  // Mezuman category (including ×›×¡×¤×™×ª) - show only accum
  const isMezuman = viewCat === 'mezuman';
  // Chov category - show chov / ×©×™× ×•×™ ×‘×—×•×‘ / %
  const isChov = viewCat === 'chov';

  if(isMezuman) {
    document.getElementById('chart-accum-label').textContent = '×¦×‘×™×¨×”';
    document.getElementById('chart-accum').textContent = Math.round(last).toLocaleString();
    growthEl.closest('div').style.display = 'none';
    returnEl.closest('div').style.display = 'none';
  } else if(isChov) {
    growthEl.closest('div').style.display = '';
    returnEl.closest('div').style.display = '';
    growthLabel.textContent = '×©×™× ×•×™ ×‘×—×•×‘';
    returnLabel.textContent = '×©×™× ×•×™ %';
    document.getElementById('chart-accum-label').textContent = '×—×•×‘';
    document.getElementById('chart-accum').textContent = Math.round(last).toLocaleString();
    growthEl.textContent = (growth < 0 ? '-' : '') + Math.abs(Math.round(growth)).toLocaleString();
    growthEl.style.color = growth <= 0 ? '#16a34a' : '#ef4444';
    if(first > 0) {
      const ret = ((last - first) / first * 100).toFixed(1);
      returnEl.textContent = (ret < 0 ? '-' : '') + Math.abs(ret) + '%';
      returnEl.style.color = ret <= 0 ? '#16a34a' : '#ef4444';
    } else { returnEl.textContent = 'â€”'; }
  } else {
    growthEl.closest('div').style.display = '';
    returnEl.closest('div').style.display = '';
    growthLabel.textContent = '×’×™×“×•×œ ×‘×—×œ×•×Ÿ';
    returnLabel.textContent = '×ª×©×•××” ×‘×—×œ×•×Ÿ';
    document.getElementById('chart-accum-label').textContent = '×¦×‘×™×¨×”';
    document.getElementById('chart-accum').textContent = Math.round(last).toLocaleString();
    growthEl.textContent = (growth < 0 ? '-' : '') + Math.abs(Math.round(growth)).toLocaleString();
    growthEl.style.color = growth >= 0 ? '#16a34a' : '#ef4444';
    if(first > 0) {
      const ret = ((last - first) / first * 100).toFixed(1);
      returnEl.textContent = (ret < 0 ? '-' : '') + Math.abs(ret) + '%';
      returnEl.style.color = ret >= 0 ? '#16a34a' : '#ef4444';
    } else { returnEl.textContent = 'â€”'; }
  }
}

function getSoldAnnotations(viewCat) {
  if (!viewCat || viewCat === 'all') return [];
  const annotations = [];
  const winLabels = getWindow(CAT_TOTALS[viewCat] || ALL_TOTALS).labels;
  Object.values(FUNDS).forEach(f => {
    if (f.cat !== viewCat) return;
    let wasActive = false;
    for (let i = 0; i < f.data.length; i++) {
      if ((f.data[i]||0) > 0) wasActive = true;
      else if (wasActive) {
        // Fund sold at index i (first 0 after being active)
        // Show annotation on last visible window point before/at sale
        const saleLabel = LABELS[i]; // e.g. ××¨×¥ 26
        const lastActiveLabel = LABELS[i-1]; // e.g. ×¤×‘×¨ 26
        // Try to place on sale month if visible, else on last active month
        let winIdx = winLabels.indexOf(saleLabel);
        if (winIdx < 0) winIdx = winLabels.indexOf(lastActiveLabel);
        if (winIdx >= 0) {
          annotations.push({ winIdx, name: f.name, value: Math.round(f.data[i-1]||0).toLocaleString() });
        }
        break;
      }
    }
  });
  return annotations;
}

function updateChart(data, color, label) {
  currentData = data;
  const w = getWindow(data);
  chart.data.labels = w.labels;
  chart.data.datasets[0].data = w.data;
  chart.data.datasets[0].borderColor = color;
  chart.data.datasets[0].backgroundColor = color.replace(')', ',0.08)').replace('rgb','rgba');
  chart.data.datasets[0].pointBackgroundColor = color;
  chart.data.datasets[0].label = label;

  // Store sold annotations for afterDraw
  chart._soldAnnotations = getSoldAnnotations(currentView);

  updateChartStats(data, currentView);;
  chart.update();
  document.getElementById('activeLabel').style.setProperty('--active-color', color);
  document.getElementById('activeLabelText').textContent = label;
}

function selectView(cat) {
  currentFund = null;
  currentView = cat;
  // Clear fund row highlights
  document.querySelectorAll('tr[data-fund]').forEach(r => r.classList.remove('fund-active'));
  // Update card highlights
  document.querySelectorAll('.card, .card-total').forEach(c => c.classList.remove('active'));
  document.getElementById('card-' + (cat==='all'?'all':cat))?.classList.add('active');
  // Update category header highlight
  document.querySelectorAll('.category-header').forEach(h => h.classList.remove('active'));
  if (cat !== 'all') document.getElementById('hdr-'+cat)?.classList.add('active');

  if (cat === 'all') {
    updateChart(ALL_TOTALS, '#1a1a2e', CAT_NAMES.all);
  } else {
    updateChart(CAT_CHART_TOTALS[cat] || CAT_TOTALS[cat], CAT_COLORS[cat], CAT_NAMES[cat]);
  }
}

function selectFund(fundKey, color) {
  const fund = FUNDS[fundKey];
  if (!fund) return;

  // If clicking same fund again - toggle delta row
  const existingDelta = document.querySelector(`.delta-row[data-delta="${fundKey}"]`);
  if (existingDelta) {
    existingDelta.classList.toggle('visible');
    return;
  }

  currentFund = fundKey;
  document.querySelectorAll('tr[data-fund]').forEach(r => r.classList.remove('fund-active'));
  const fundRow = document.querySelector(`tr[data-fund="${fundKey}"]`);
  fundRow?.classList.add('fund-active');

  // Remove any existing delta rows
  document.querySelectorAll('.delta-row').forEach(r => r.remove());

  // Build delta row â€“ only for non-mezuman funds
  const NO_DELTA_CATS = ['mezuman'];
  if (fundRow && !NO_DELTA_CATS.includes(fund.cat)) {
    const deltaRow = document.createElement('tr');
    deltaRow.className = 'delta-row visible';
    deltaRow.setAttribute('data-delta', fundKey);

    // Label cell
    const labelTd = document.createElement('td');
    labelTd.textContent = '×©×™× ×•×™ ×—×•×“×©×™';
    deltaRow.appendChild(labelTd);

    // Delta cells for each month
    fund.data.forEach((v, i) => {
      const td = document.createElement('td');
      td.setAttribute('data-col', i);
      // Check visibility
      if (i < winStart || i > winStart + WINDOW - 1) td.style.display = 'none';

      if (i === 0 || v === null) {
        td.textContent = 'â€”';
      } else {
        const prev = fund.data[i-1];
        if (prev === null || prev === 0) { td.textContent = 'â€”'; }
        else {
          const delta = v - prev;
          const pct = (delta / prev * 100).toFixed(1);
          const sign = delta >= 0 ? '+' : '';
          const cls = delta > 0 ? 'dpos' : (delta < 0 ? 'dneg' : 'dzer');
          td.innerHTML = `<span class="${cls} dval">${sign}${delta}</span><br><span class="${cls}">${sign}${pct}%</span>`;
        }
      }
      deltaRow.appendChild(td);
    });

    fundRow.insertAdjacentElement('afterend', deltaRow);
  }

  document.querySelectorAll('.card, .card-total').forEach(c => c.classList.remove('active'));
  updateChart(fund.data.map(v => v ?? NaN), color, fund.name);
}

function toggleCat(id) {
  const body = document.getElementById('body-' + id);
  const chev = document.getElementById('chev-' + id);
  body.classList.toggle('open');
  chev.classList.toggle('open');
}

function saveToLocalStorage() {
  try {
    const payload = {
      labels: LABELS,
      funds: {}
    };
    Object.entries(FUNDS).forEach(([k, f]) => { payload.funds[k] = f.data; });
    localStorage.setItem('dashboard_v15_data', JSON.stringify(payload));
  } catch(e) { console.warn('×©××™×¨×” × ×›×©×œ×”:', e); }
}

function loadFromLocalStorage() {
  try {
    const raw = localStorage.getItem('dashboard_v15_data');
    if (!raw) return false;
    const payload = JSON.parse(raw);
    if (!payload.labels || !payload.funds) return false;
    // Restore LABELS
    LABELS.length = 0;
    payload.labels.forEach(l => LABELS.push(l));
    // Restore FUNDS data
    Object.entries(payload.funds).forEach(([k, data]) => {
      if (FUNDS[k]) FUNDS[k].data = data;
    });
    // Recalculate totals
    Object.keys(CAT_TOTALS).forEach(cat => { CAT_TOTALS[cat].length = 0; });
    LABELS.forEach((_, i) => {
      Object.entries(CAT_TOTALS).forEach(([cat, arr]) => {
        const vals = Object.values(FUNDS).filter(f => f.cat===cat).map(f => f.data[i]||0);
        arr.push(vals.reduce((a,b)=>a+b,0));
      });
    });
    ALL_TOTALS.length = 0;
    LABELS.forEach((_, i) => {
      let t = 0;
      Object.entries(CAT_TOTALS).forEach(([cat, arr]) => { t += cat === 'chov' ? -(arr[i]||0) : (arr[i]||0); });
      ALL_TOTALS.push(t);
    });
    return true;
  } catch(e) { console.warn('×˜×¢×™× ×” × ×›×©×œ×”:', e); return false; }
}

function updateTableCells() {
  const numCols = LABELS.length;

  // Add missing header columns to all tables
  document.querySelectorAll('thead tr').forEach(headerRow => {
    const existingCols = headerRow.querySelectorAll('th[data-col]').length;
    // Find max existing col index
    let maxCol = -1;
    headerRow.querySelectorAll('th[data-col]').forEach(th => {
      maxCol = Math.max(maxCol, parseInt(th.getAttribute('data-col')));
    });
    // Add missing columns
    for (let c = maxCol + 1; c < numCols; c++) {
      const th = document.createElement('th');
      th.setAttribute('data-col', c);
      th.textContent = LABELS[c];
      headerRow.appendChild(th);
    }
    // Update existing header labels
    headerRow.querySelectorAll('th[data-col]').forEach(th => {
      const col = parseInt(th.getAttribute('data-col'));
      if (col < numCols) th.textContent = LABELS[col];
    });
  });

  // Add missing td cells to fund rows and update values
  document.querySelectorAll('tr[data-fund]').forEach(row => {
    const fundKey = row.getAttribute('data-fund');
    const fund = FUNDS[fundKey];
    if (!fund) return;
    let maxCol = -1;
    row.querySelectorAll('td[data-col]').forEach(td => {
      maxCol = Math.max(maxCol, parseInt(td.getAttribute('data-col')));
    });
    // Add missing tds
    for (let c = maxCol + 1; c < numCols; c++) {
      const td = document.createElement('td');
      td.setAttribute('data-col', c);
      row.appendChild(td);
    }
    // Update all tds
    row.querySelectorAll('td[data-col]').forEach(td => {
      const col = parseInt(td.getAttribute('data-col'));
      if (col >= numCols) return;
      const val = fund.data[col];
      if (val === null || val === undefined || isNaN(val)) {
        td.textContent = 'â€”';
        td.className = 'dash';
      } else {
        td.textContent = Math.round(val).toLocaleString();
        td.className = 'val';
      }
    });
  });

  // Add missing td cells to total rows and update values
  document.querySelectorAll('tr.total-row').forEach(row => {
    const section = row.closest('.category-section');
    if (!section) return;
    const catId = section.id.replace('sec-', '');
    const catArr = CAT_TOTALS[catId];
    if (!catArr) return;
    let maxCol = -1;
    row.querySelectorAll('td[data-col]').forEach(td => {
      maxCol = Math.max(maxCol, parseInt(td.getAttribute('data-col')));
    });
    for (let c = maxCol + 1; c < numCols; c++) {
      const td = document.createElement('td');
      td.setAttribute('data-col', c);
      row.appendChild(td);
    }
    row.querySelectorAll('td[data-col]').forEach(td => {
      const col = parseInt(td.getAttribute('data-col'));
      if (col >= catArr.length) return;
      td.textContent = Math.round(Math.abs(catArr[col])).toLocaleString();
      td.className = 'val';
    });
  });
}

// ===== NOTES SYSTEM =====
const NOTES = [];

const NOTE_TYPE_COLOR = {
  '××›×™×¨×ª × ×›×¡': '#dc2626',
  '×§× ×™×™×ª × ×›×¡': '#16a34a',
  '×”×›×¨×” ×‘××–×•××Ÿ': '#0891b2',
  '×”×¢×‘×¨×” ×‘×™×Ÿ ×§×¨× ×•×ª': '#7c3aed',
  '××—×¨': '#64748b',
};

function showAddForm() {
  document.getElementById('notes-add-form').style.display = 'block';
  // Set today's date
  const d = new Date();
  const dd = String(d.getDate()).padStart(2,'0');
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const yyyy = d.getFullYear();
  document.getElementById('nf-date').value = dd+'/'+mm+'/'+yyyy;
  // Show/hide sale fields based on type
  document.getElementById('nf-type').onchange = updateNoteFields;
  updateNoteFields();
}

function updateNoteFields() {
  const type = document.getElementById('nf-type').value;
  const hasSale = ['××›×™×¨×ª × ×›×¡','×§× ×™×™×ª × ×›×¡'].includes(type);
  const hasAmount = ['×”×›×¨×” ×‘××–×•××Ÿ','×”×¢×‘×¨×” ×‘×™×Ÿ ×§×¨× ×•×ª','××—×¨'].includes(type);
  document.getElementById('nf-fields-sale').style.display = hasSale ? 'grid' : 'none';
  document.getElementById('nf-fields-amount').style.display = hasAmount ? 'block' : 'none';
}

function hideAddForm() {
  document.getElementById('notes-add-form').style.display = 'none';
  ['nf-date','nf-title','nf-gross','nf-tax','nf-net','nf-link','nf-amount'].forEach(id => {
    document.getElementById(id).value = '';
  });
}

function saveNewNote() {
  const date = document.getElementById('nf-date').value.trim();
  const type = document.getElementById('nf-type').value;
  const title = document.getElementById('nf-title').value.trim();
  const gross = document.getElementById('nf-gross').value.trim();
  const tax = document.getElementById('nf-tax').value.trim();
  const net = document.getElementById('nf-net').value.trim();
  const link = document.getElementById('nf-link').value.trim();

  if (!date || !title) { alert('× × ×œ××œ× ×ª××¨×™×š ×•×¤×™×¨×•×˜'); return; }

  // Parse month key from date DD/MM/YYYY
  const parts = date.split('/');
  const monthKey = parts.length === 3 ? parts[2] + '-' + parts[1].padStart(2,'0') : '';

  const amount = document.getElementById('nf-amount').value.trim();
  const fields = [];
  if (gross) fields.push({ label: '×¡×›×•× ×›×•×œ×œ ×‘×¤×•×œ×™×¡×”', value: gross });
  if (tax)   fields.push({ label: '××¡ ×¨×•×•×— ×”×•×Ÿ', value: tax });
  if (net)   fields.push({ label: '×ª××•×¨×” × ×˜×• ×œ×—×©×‘×•×Ÿ', value: net });
  if (amount) fields.push({ label: '×¡×›×•×', value: amount });

  const note = { date, month: monthKey, type, title, fields, link: link || null, linkLabel: link ? '××¡××š ×¨×¤×¨× ×¡' : null };
  NOTES.unshift(note); // newest first
  saveNotesToStorage();
  hideAddForm();
  renderNotesList();
  markNoteMonths();
}

function deleteNote(i) {
  if (!confirm('×œ××—×•×§ ×”×¢×¨×” ×–×•?')) return;
  NOTES.splice(i, 1);
  saveNotesToStorage();
  renderNotesList();
  markNoteMonths();
}

function editNote(i) {
  const n = NOTES[i];
  showAddForm();
  document.getElementById('nf-date').value = n.date;
  document.getElementById('nf-type').value = n.type;
  document.getElementById('nf-title').value = n.title;
  const gross = n.fields.find(f => f.label === '×¡×›×•× ×›×•×œ×œ ×‘×¤×•×œ×™×¡×”');
  const tax   = n.fields.find(f => f.label === '××¡ ×¨×•×•×— ×”×•×Ÿ');
  const net   = n.fields.find(f => f.label === '×ª××•×¨×” × ×˜×• ×œ×—×©×‘×•×Ÿ');
  if (gross) document.getElementById('nf-gross').value = gross.value;
  if (tax)   document.getElementById('nf-tax').value = tax.value;
  if (net)   document.getElementById('nf-net').value = net.value;
  document.getElementById('nf-link').value = n.link || '';
  // Remove old note and save new on submit
  NOTES.splice(i, 1);
  saveNotesToStorage();
  renderNotesList();
}

function saveNotesToStorage() {
  try { localStorage.setItem('dashboard_v15_notes', JSON.stringify(NOTES)); } catch(e) {}
}

function loadNotesFromExcel(workbook) {
  try {
    const sheet = workbook.Sheets['Notes'];
    if (!sheet) return;
    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: null });
    // Find header row
    let headerIdx = -1;
    for (let i = 0; i < rows.length; i++) {
      if (rows[i] && rows[i].includes('×ª××¨×™×š')) { headerIdx = i; break; }
    }
    if (headerIdx < 0) return;
    const headers = rows[headerIdx];
    const iDate   = headers.indexOf('×ª××¨×™×š');
    const iType   = headers.indexOf('×¡×•×’');
    const iTitle  = headers.indexOf('×¤×™×¨×•×˜');
    const iGross  = headers.indexOf('×¡×›×•× ×›×•×œ×œ');
    const iTax    = headers.indexOf('××¡');
    const iNet    = headers.indexOf('× ×˜×•');
    const iAmount = headers.indexOf('×¡×›×•×');
    const iLink   = headers.indexOf('×§×™×©×•×¨');

    const excelNotes = [];
    for (let i = headerIdx + 1; i < rows.length; i++) {
      const r = rows[i];
      if (!r || !r[iDate]) continue;
      // Format date
      let dateStr = '';
      const raw = r[iDate];
      if (typeof raw === 'number') {
        // Excel serial date - use local time
        const d = new Date(Math.round((raw - 25569) * 86400 * 1000));
        const dd = String(d.getUTCDate()).padStart(2,'0');
        const mm = String(d.getUTCMonth()+1).padStart(2,'0');
        dateStr = dd + '/' + mm + '/' + d.getUTCFullYear();
      } else if (raw instanceof Date) {
        // cellDates:true gives local date - use UTC to avoid timezone shift
        const dd = String(raw.getUTCDate()).padStart(2,'0');
        const mm = String(raw.getUTCMonth()+1).padStart(2,'0');
        dateStr = dd + '/' + mm + '/' + raw.getUTCFullYear();
      } else {
        dateStr = String(raw);
      }
      // Month key
      const parts = dateStr.split('/');
      const monthKey = parts.length === 3 ? parts[2] + '-' + parts[1].padStart(2,'0') : '';
      // Fields
      const fields = [];
      if (r[iGross]) fields.push({ label: '×¡×›×•× ×›×•×œ×œ ×‘×¤×•×œ×™×¡×”', value: String(r[iGross]) });
      if (r[iTax])   fields.push({ label: '××¡ ×¨×•×•×— ×”×•×Ÿ',        value: String(r[iTax]) });
      if (r[iNet])   fields.push({ label: '×ª××•×¨×” × ×˜×• ×œ×—×©×‘×•×Ÿ',   value: String(r[iNet]) });
      if (r[iAmount])fields.push({ label: '×¡×›×•×',               value: String(r[iAmount]) });

      excelNotes.push({
        date: dateStr,
        month: monthKey,
        type: r[iType] || '××—×¨',
        title: r[iTitle] || '',
        fields,
        link: r[iLink] || null,
        linkLabel: r[iLink] ? '××¡××š ×¨×¤×¨× ×¡' : null
      });
    }
    if (excelNotes.length === 0) return;
    // Merge: excel notes override, keep built-in not in excel
    const excelKeys = new Set(excelNotes.map(n => n.date + n.title));
    // Keep hardcoded notes not present in excel
    const hardcoded = NOTES.filter(n => n._hardcoded && !excelKeys.has(n.date + n.title));
    NOTES.length = 0;
    // newest first: sort by date desc
    const all = [...excelNotes, ...hardcoded].sort((a,b) => {
      const pd = s => { const p = s.split('/'); return p.length===3 ? new Date(p[2],p[1]-1,p[0]) : new Date(0); };
      return pd(b.date) - pd(a.date);
    });
    all.forEach(n => NOTES.push(n));
    saveNotesToStorage();
  } catch(e) { console.warn('×©×’×™××” ×‘×§×¨×™××ª Notes:', e); }
}

function loadNotesFromStorage() {
  try {
    const raw = localStorage.getItem('dashboard_v15_notes');
    if (!raw) return;
    const saved = JSON.parse(raw);
    // Merge: saved notes first, then built-in notes not already present
    const savedTitles = new Set(saved.map(n => n.date + n.title));
    const builtIn = NOTES.filter(n => !savedTitles.has(n.date + n.title));
    NOTES.length = 0;
    saved.forEach(n => NOTES.push(n));
    builtIn.forEach(n => NOTES.push(n));
  } catch(e) {}
}

function openNotes() {
  renderNotesList();
  const modal = document.getElementById('notes-modal');
  modal.style.display = 'flex';
}

function closeNotes() {
  document.getElementById('notes-modal').style.display = 'none';
}

function renderNotesList() {
  const list = document.getElementById('notes-list');
  if (NOTES.length === 0) {
    list.innerHTML = '<p style="color:#888; text-align:center; padding:20px;">××™×Ÿ ×”×¢×¨×•×ª ×¢×“×™×™×Ÿ</p>';
    return;
  }

  // Table headers based on note type columns
  const colHeaders = ['×§×™×©×•×¨','×ª××•×¨×” × ×˜×•','××¡','×¡×›×•× ×›×•×œ×œ','×¤×™×¨×•×˜','××™×¨×•×¢','×ª××¨×™×š',''];
  
  let tableHtml = '<table style="width:100%; border-collapse:collapse; font-size:13px; font-family:Heebo,sans-serif;" dir="rtl">';
  // Header row
  tableHtml += '<thead><tr style="border-bottom:2px solid #1a1a2e;">';
  colHeaders.forEach(h => {
    tableHtml += '<th style="padding:8px 10px; color:#1a1a2e; font-weight:700; text-align:right; white-space:nowrap;">' + h + '</th>';
  });
  tableHtml += '</tr></thead><tbody>';

  // Data rows (newest first)
  NOTES.forEach((n, i) => {
    const color = NOTE_TYPE_COLOR[n.type] || '#64748b';
    const bg = i % 2 === 0 ? '#f9fafb' : 'white';
    const gross = n.fields.find(f => f.label === '×¡×›×•× ×›×•×œ×œ ×‘×¤×•×œ×™×¡×”');
    const tax   = n.fields.find(f => f.label === '××¡ ×¨×•×•×— ×”×•×Ÿ');
    const net   = n.fields.find(f => f.label === '×ª××•×¨×” × ×˜×• ×œ×—×©×‘×•×Ÿ') || n.fields.find(f => f.label === '×¡×›×•×');
    const linkHtml = n.link
      ? '<a href="' + n.link + '" target="_blank" style="color:#0891b2; text-decoration:none; font-size:14px; font-weight:600;">××¡××š â†—</a>'
      : '';
    const taxVal = tax ? '<span style="color:#dc2626;">-' + tax.value + '</span>' : 'â€”';

    tableHtml += '<tr style="background:' + bg + '; border-bottom:1px solid #e5e7eb;">' +
      '<td style="padding:10px 16px; text-align:right; white-space:nowrap;">' + linkHtml + '</td>' +
      '<td style="padding:10px 16px; text-align:right; font-weight:700; white-space:nowrap;">' + (net ? net.value : 'â€”') + '</td>' +
      '<td style="padding:10px 16px; text-align:right; white-space:nowrap;">' + taxVal + '</td>' +
      '<td style="padding:10px 16px; text-align:right; white-space:nowrap;">' + (gross ? gross.value : 'â€”') + '</td>' +
      '<td style="padding:10px 16px; font-weight:600; white-space:nowrap;">' + n.title + '</td>' +
      '<td style="padding:10px;"><span style="background:' + color + '20; color:' + color + '; padding:2px 8px; border-radius:20px; font-size:11px; font-weight:700; white-space:nowrap;">' + n.type + '</span></td>' +
      '<td style="padding:10px; white-space:nowrap; color:#555;">' + n.date + '</td>' +
      '<td style="padding:10px; white-space:nowrap;">' +
        '<button onclick="editNote(' + i + ')" style="background:none; border:none; cursor:pointer; font-size:14px; padding:2px 5px;" title="×¢×¨×™×›×”">âœï¸</button>' +
        '<button onclick="deleteNote(' + i + ')" style="background:none; border:none; cursor:pointer; font-size:14px; padding:2px 5px;" title="××—×™×§×”">ğŸ—‘ï¸</button>' +
      '</td>' +
      '</tr>';
  });

  tableHtml += '</tbody></table>';
  list.innerHTML = tableHtml;
}

// Mark chart months that have notes
function markNoteMonths() {
  // Will color x-axis labels that have notes
  const noteMonths = new Set(NOTES.map(n => n.month));
  if (!chart || !chart.data.labels) return;
  const labels = chart.data.labels;
  // Map label to month key
  const MONTH_HEB = {'×™× ×•':1,'×¤×‘×¨':2,'××¨×¥':3,'××¤×¨':4,'×××™':5,'×™×•× ':6,'×™×•×œ':7,'××•×’':8,'×¡×¤×˜':9,'××•×§':10,'× ×•×‘':11,'×“×¦×':12};
  chart.options.scales.x.ticks.color = function(ctx) {
    const label = ctx.tick && labels[ctx.index];
    if (!label) return '#64748b';
    // Parse label like "×¤×‘×¨' 26"
    const m = label.match(/^(×-×ª{2,3})'\s*(\d{2})$/);
    if (!m) return '#64748b';
    const mon = MONTH_HEB[m[1]];
    const yr = 2000 + parseInt(m[2]);
    const key = yr + '-' + String(mon).padStart(2,'0');
    return noteMonths.has(key) ? '#f59e0b' : '#64748b';
  };
  chart.update();
}

// ===== END NOTES SYSTEM =====

// Init â€“ load last saved data if available
if (loadFromLocalStorage()) {
  winStart = Math.max(0, LABELS.length - WINDOW);
  // Update table headers
  document.querySelectorAll('th[data-col]').forEach(th => {
    const col = parseInt(th.getAttribute('data-col'));
    if (col >= 0 && col < LABELS.length) th.textContent = LABELS[col];
  });
  updateTableCells();
  // Refresh chart with loaded data
  currentData = ALL_TOTALS;
  const w = getWindow(ALL_TOTALS);
  chart.data.labels = w.labels;
  chart.data.datasets[0].data = w.data;
  chart.update();
}
loadNotesFromStorage();
document.getElementById('card-all').classList.add('active');
updateNavButtons();
updateChartStats(currentData, currentView);
markNoteMonths();
</script>

<style>

</style>



<!-- CHAT -->
<div id="cb" onclick="toggleChat()" style="position:fixed;bottom:24px;left:24px;width:52px;height:52px;background:#1a1a2e;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:22px;cursor:pointer;box-shadow:0 4px 16px rgba(0,0,0,0.3);z-index:9999;">ğŸ’¬</div>
<div id="cp" style="display:none;position:fixed;bottom:88px;left:24px;width:340px;max-height:460px;background:#1a1a2e;border-radius:14px;box-shadow:0 8px 32px rgba(0,0,0,0.4);flex-direction:column;z-index:9999;overflow:hidden;border:1px solid rgba(255,255,255,0.1);">
  <div style="padding:12px 16px;background:#0f0f23;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid rgba(255,255,255,0.1);">
    <span style="color:white;font-family:Heebo,sans-serif;font-size:14px;font-weight:600;">ğŸ¤– ×©××œ ×¢×œ ×”×“×©×‘×•×¨×“</span>
    <span onclick="toggleChat()" style="color:#888;cursor:pointer;font-size:18px;">âœ•</span>
  </div>
  <div id="cm" style="flex:1;overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:10px;min-height:180px;max-height:300px;"></div>
  <div style="padding:10px;display:flex;gap:8px;border-top:1px solid rgba(255,255,255,0.1);">
    <input id="ci" type="text" placeholder="×©××œ ×©××œ×”..." onkeydown="if(event.key==='Enter')sendChat()" style="flex:1;background:#0f0f23;border:1px solid rgba(255,255,255,0.15);border-radius:8px;padding:8px 10px;color:white;font-family:Heebo,sans-serif;font-size:13px;direction:rtl;outline:none;"/>
    <button onclick="sendChat()" style="background:#4ade80;color:#0f0f23;border:none;border-radius:8px;padding:8px 12px;font-family:Heebo,sans-serif;font-size:13px;font-weight:700;cursor:pointer;">×©×œ×—</button>
  </div>
</div>
<script>
var chatOpen = false;
function toggleChat() {
  chatOpen = !chatOpen;
  var cp = document.getElementById('cp');
  cp.style.display = chatOpen ? 'flex' : 'none';
  if(chatOpen) {
    var cm = document.getElementById('cm');
    if(cm.children.length === 0) addMsg('×©×œ×•×! ×©××œ ××•×ª×™ ×›×œ ×©××œ×” ×¢×œ ×”×“×©×‘×•×¨×“. ×œ××©×œ: ×›××” ×”×™×” ×”×¨××œ ×‘×¡×¤×˜××‘×¨ 25?', false);
    setTimeout(function(){ document.getElementById('ci').focus(); }, 100);
  }
}
function addMsg(txt, isUser) {
  var cm = document.getElementById('cm');
  var d = document.createElement('div');
  d.style.cssText = 'padding:9px 12px;border-radius:10px;font-family:Heebo,sans-serif;font-size:13px;line-height:1.5;direction:rtl;max-width:85%;white-space:pre-wrap;';
  if(isUser) {
    d.style.cssText += 'background:#2d2d4e;color:white;align-self:flex-end;margin-right:auto;';
  } else {
    d.style.cssText += 'background:#0f3460;color:#e2e8f0;align-self:flex-start;margin-left:auto;';
  }
  d.textContent = txt;
  cm.appendChild(d);
  cm.scrollTop = cm.scrollHeight;
  return d;
}
var chatHistory = [];

async function sendChat() {
  var ci = document.getElementById('ci');
  var q = ci.value.trim();
  if(!q) return;
  ci.value = '';
  addMsg(q, true);
  chatHistory.push({role:'user', content: q});

  var thinking = addMsg('×—×•×©×‘...', false);

  try {
    var ctx = buildContext();
    var controller = new AbortController();
    var timeout = setTimeout(function(){ controller.abort(); }, 25000);
    var res = await fetch('https://holy-poetry-claude-proxy.roy-benyamini.workers.dev', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      signal: controller.signal,
      body: JSON.stringify({
        model: 'claude-haiku-4-5-20251001',
        max_tokens: 800,
        system: '××ª×” ×¢×•×–×¨ ×¤×™× × ×¡×™ ×©×× ×ª×— ×ª×™×§ ×”×©×§×¢×•×ª. ×¢× ×” ×‘×¢×‘×¨×™×ª ×‘×ª××¦×™×ª×™×•×ª.\n' +
               '×”× ×ª×•× ×™× ×”× ×¢×¨×›×™ ×¦×‘×™×¨×” ×—×•×“×©×™×™× ×‘××œ×¤×™ ×©\"×— (×œ× ×ª×–×¨×™××™×).\n' +
               '×ª×©×•××” = (×¢×¨×š ×¡×•×£ ×ª×§×•×¤×” - ×¢×¨×š ×ª×—×™×œ×ª ×ª×§×•×¤×”) / ×¢×¨×š ×ª×—×™×œ×ª ×ª×§×•×¤×” * 100.\n' +
               '×”× ×ª×•× ×™× ×œ×¤×™ ×¡×“×¨ ×”×—×•×“×©×™× ×©××•×¤×™×¢×™× ×‘×©×•×¨×ª "×—×•×“×©×™×".\n' +
               '×™× ×•\' 25 = ×—×•×“×© ×¨××©×•×Ÿ, ×“×¦×\' 25 = ×—×•×“×© 12, ×™× ×•\' 26 = ×—×•×“×© 13, ×¤×‘×¨\' 26 = ×—×•×“×© 14.\n\n' + ctx,
        messages: chatHistory
      })
    });
    clearTimeout(timeout);
    var data = await res.json();
    thinking.remove();
    var answer = (data.content && data.content[0]) ? data.content[0].text : JSON.stringify(data);
    chatHistory.push({role:'assistant', content: answer});
    addMsg(answer, false);
  } catch(e) {
    thinking.remove();
    addMsg('×©×’×™××”: ' + e.message, false);
  }
}

function buildContext() {
  var ctx = '×ª×™×§ ×”×©×§×¢×•×ª ×‘××œ×¤×™ ×©"×—.\n';
  ctx += '×—×•×“×©×™×: ' + LABELS.join(',') + '\n';
  ctx += '× ×ª×•× ×™× ×œ×›×œ ×§×¨×Ÿ (×œ×¤×™ ×¡×“×¨ ×”×—×•×“×©×™×):\n';
  Object.values(FUNDS).forEach(function(f) {
    ctx += f.name + ' [' + CAT_NAMES[f.cat] + ']: ' + 
           f.data.map(function(v){return v!=null?Math.round(v):'';}).join(',') + '\n';
  });
  ctx += '×¡×”×› ×ª×™×§: ' + ALL_TOTALS.map(function(v){return Math.round(v);}).join(',') + '\n';
  // Add notes to context
  if (NOTES.length > 0) {
    ctx += '\n×”×¢×¨×•×ª ×ª×™×§:\n';
    NOTES.forEach(function(n) {
      ctx += '- ' + n.date + ' | ' + n.type + ' | ' + n.title;
      n.fields.forEach(function(f) { ctx += ' | ' + f.label + ': ' + f.value; });
      ctx += '\n';
    });
  }
  return ctx;
}
function answerQ(q) {
  var months = {'×™× ×•':0,'×™× ×•××¨':0,'×¤×‘×¨':1,'×¤×‘×¨×•××¨':1,'××¨×¥':2,'××¨×¡':2,'××¤×¨':3,'××¤×¨×™×œ':3,'×××™':4,'×™×•× ×™':5,'×™×•×œ×™':6,'××•×’':7,'××•×’×•×¡×˜':7,'×¡×¤×˜':8,'×¡×¤×˜××‘×¨':8,'××•×§':9,'××•×§×˜×•×‘×¨':9,'× ×•×‘':10,'× ×•×‘××‘×¨':10,'×“×¦×':11,'×“×¦××‘×¨':11};
  function getMonths(str) {
    var res = [], toks = str.replace(/[,?]/g,' ').split(' ');
    for(var i=0;i<toks.length;i++) {
      for(var key in months) {
        if(toks[i].indexOf(key)>=0) {
          var ctx = toks.slice(i,i+3).join(' ');
          var yr = (ctx.indexOf('2026')>=0||ctx.indexOf("'26")>=0) ? 26 : 25;
          res.push(Math.min(yr===26?months[key]+12:months[key], LABELS.length-1));
          break;
        }
      }
    }
    return res;
  }
  function getFund(str) {
    var checks = [['×”×¨××œ ××’×•×•×Ÿ','××’×•×•×Ÿ'],['×¤×•×œ×™×¡×ª ×—×™×¡×›×•×Ÿ','××’×•×•×Ÿ'],['928884078','××’×•×•×Ÿ'],['×”×¨××œ ×× ×™×•×ª','×× ×™×•×ª'],['106863031','×× ×™×•×ª'],['×”×¨××œ ×›×œ×œ×™','×›×œ×œ×™'],['109062745','×›×œ×œ×™'],['××¨×‘×™×˜×¨××–','××¨×‘×™×˜×¨××–'],['×•××œ×™×•','××¨×‘×™×˜×¨××–'],['××™×˜×‘ ×§×¨× ×•×ª','169301968'],['169301968','169301968'],['×˜×¨×™×™×“','×˜×¨×™×™×“'],['×›×¡×¤×™×ª','×›×¡×¤×™×ª'],['××•×¨ ×’××œ','××•×¨ ×’××œ'],['××•×¨ ×§×”','××•×¨ ×§×”'],['×¤× ×™×§×¡','×¤× ×™×§×¡'],['×©×§×œ×™','×©×§×œ×™'],['×“×•×œ×¨×™','×“×•×œ×¨×™']];
    for(var i=0;i<checks.length;i++) {
      if(str.indexOf(checks[i][0])>=0) {
        for(var k in FUNDS) if(FUNDS[k].name.toLowerCase().indexOf(checks[i][1])>=0) return FUNDS[k];
      }
    }
    return null;
  }
  function catSum(cat,idx) { return Object.values(FUNDS).filter(function(f){return f.cat===cat;}).reduce(function(s,f){return s+(f.data[idx]||0);},0); }
  function fmt(name,v1,v2,l1,l2) { var d=v2-v1,p=v1>0?(d/v1*100).toFixed(1):'â€”'; return name+':\n'+l1+': '+Math.round(v1).toLocaleString()+'\n'+l2+': '+Math.round(v2).toLocaleString()+'\n×©×™× ×•×™: '+(d>=0?'+':'')+Math.round(d).toLocaleString()+' ('+(d>=0?'+':'')+p+'%)'; }
  var mi = getMonths(q);
  var yf=-1,yt=-1;
  if(q.indexOf('2025')>=0&&q.indexOf('2026')<0){yf=0;yt=11;}
  else if(q.indexOf('2026')>=0&&q.indexOf('2025')<0){yf=12;yt=LABELS.length-1;}
  else if(q.indexOf('2025')>=0&&q.indexOf('2026')>=0){yf=0;yt=LABELS.length-1;}
  var isChg = ['×¢×œ×”','×™×¨×“','×©×™× ×•×™','×¢×œ×™×™×”','×’×“×œ','×‘×›××”','×ª×©×•××”','×¢×œ×ª×”','×™×¨×“×”','×”×©×ª× ×”','×”×¤×¨×©','×‘×™×¦×•×¢×™×'].some(function(w){return q.indexOf(w)>=0;});
  var fund = getFund(q);
  if(fund) {
    // Best/worst month for a fund
    if(q.indexOf('×—×•×“×©')>=0&&(q.indexOf('×’×‘×•×”')>=0||q.indexOf('××§×¡×™××•×')>=0||q.indexOf('×”×›×™')>=0)) {
      var fi5=yf>=0?yf:0, ti5=yt>=0?yt:LABELS.length-1;
      var maxV=-Infinity, maxL='';
      for(var i5=fi5;i5<=ti5;i5++) { if((fund.data[i5]||0)>maxV){maxV=fund.data[i5];maxL=LABELS[i5];} }
      return fund.name+':\n×”×—×•×“×© ×”×’×‘×•×” ×‘×™×•×ª×¨: '+maxL+'\n×¢×¨×š: '+maxV.toLocaleString()+' ××œ×¤×™ ×©"×—';
    }
    if(q.indexOf('×—×•×“×©')>=0&&(q.indexOf('× ××•×š')>=0||q.indexOf('××™× ×™××•×')>=0)) {
      var fi6=yf>=0?yf:0, ti6=yt>=0?yt:LABELS.length-1;
      var minV=Infinity, minL='';
      for(var i6=fi6;i6<=ti6;i6++) { var v6=fund.data[i6]||0; if(v6>0&&v6<minV){minV=v6;minL=LABELS[i6];} }
      return fund.name+':\n×”×—×•×“×© ×”× ××•×š ×‘×™×•×ª×¨: '+minL+'\n×¢×¨×š: '+minV.toLocaleString()+' ××œ×¤×™ ×©"×—';
    }
    if(mi.length>=2) return fmt(fund.name,fund.data[mi[0]]||0,fund.data[mi[1]]||0,LABELS[mi[0]],LABELS[mi[1]]);
    if(yf>=0||isChg) { var fi=yf>=0?yf:0,ti=yt>=0?yt:LABELS.length-1; return fmt(fund.name,fund.data[fi]||0,fund.data[ti]||0,LABELS[fi],LABELS[ti]); }
    if(mi.length===1) return fund.name+' ×‘'+LABELS[mi[0]]+': '+(fund.data[mi[0]]!=null?fund.data[mi[0]].toLocaleString()+' ××œ×¤×™ ×©"×—':'××™×Ÿ × ×ª×•×Ÿ');
    return fmt(fund.name,fund.data[0]||0,fund.data[LABELS.length-1]||0,LABELS[0],LABELS[LABELS.length-1]);
  }
  var cats = {'hishtalmut':['×”×©×ª×œ××•×ª'],'gemel':['×§×•×¤×•×ª ×’××œ','×§×•×¤×ª ×’××œ','×’××œ'],'gemel_invest':['×’××œ ×œ×”×©×§×¢×”'],'harel':['×”×¨××œ'],'meitav':['××™×˜×‘'],'mezuman':['××–×•××Ÿ'],'arbitrage':['××¨×‘×™×˜×¨××–'],'dira':['×“×™×¨×”'],'chov':['×—×•×‘']};
  for(var cat in cats) {
    if(cats[cat].some(function(kw){return q.indexOf(kw)>=0;})) {
      if(mi.length===1&&!isChg&&yf<0) return CAT_NAMES[cat]+' ×‘'+LABELS[mi[0]]+': '+Math.round(catSum(cat,mi[0])).toLocaleString()+' ××œ×¤×™ ×©"×—';
      if(isChg||yf>=0) { var fi2=yf>=0?yf:(mi[0]!=null?mi[0]:0),ti2=yt>=0?yt:(mi[1]!=null?mi[1]:LABELS.length-1); return fmt(CAT_NAMES[cat],catSum(cat,fi2),catSum(cat,ti2),LABELS[fi2],LABELS[ti2]); }
      return fmt(CAT_NAMES[cat],catSum(cat,0),catSum(cat,LABELS.length-1),LABELS[0],LABELS[LABELS.length-1]);
    }
  }
  if(q.indexOf('×ª×©×•××”')>=0||q.indexOf('×‘×™×¦×•×¢×™×')>=0) {
    var fi3=yf>=0?yf:0,ti3=yt>=0?yt:LABELS.length-1,lines=[];
    ['hishtalmut','gemel','gemel_invest','harel','meitav'].forEach(function(c){var v1=catSum(c,fi3),v2=catSum(c,ti3),d=v2-v1,p=v1>0?(d/v1*100).toFixed(1):'â€”';lines.push(CAT_NAMES[c]+': '+(d>=0?'+':'')+p+'%');});
    return '×ª×©×•××” '+LABELS[fi3]+' â€“ '+LABELS[ti3]+':\n'+lines.join('\n');
  }
  if(q.indexOf('×¡×š')>=0||q.indexOf('×¡×”"×›')>=0||q.indexOf('×ª×™×§')>=0||q.indexOf('×›×•×œ×œ')>=0) {
    if(mi.length===1) return '×¡×”"×› ×ª×™×§ ×‘'+LABELS[mi[0]]+': '+Math.round(ALL_TOTALS[mi[0]]).toLocaleString()+' ××œ×¤×™ ×©"×—';
    var fi4=yf>=0?yf:0,ti4=yt>=0?yt:LABELS.length-1;
    return fmt('×¡×”"×› ×ª×™×§',ALL_TOTALS[fi4],ALL_TOTALS[ti4],LABELS[fi4],LABELS[ti4]);
  }
  return '×× ×™ ×™×›×•×œ ×œ×¢× ×•×ª ×¢×œ:\nâ€¢ ×›××” ×”×™×” ×”×¨××œ ××’×•×•×Ÿ ×‘×¡×¤×˜××‘×¨ 25?\nâ€¢ ×‘×›××” ×¢×œ×ª×” ×”×¨××œ ××’×•×•×Ÿ ×‘×©× ×ª 2025?\nâ€¢ ××” ×”×ª×©×•××” ×©×œ ×›×œ ×”×§×˜×’×•×¨×™×•×ª?\nâ€¢ ×¡×š ×”×›×œ ×”×ª×™×§ ×‘×“×¦××‘×¨ 25?';
}

// ===== EXCEL LOADER =====
function loadExcelFile(input) {
  var file = input.files[0];
  if (!file) return;
  var status = document.getElementById('excel-status');
  status.textContent = '×§×•×¨× ×§×•×‘×¥...';
  
  var reader = new FileReader();
  reader.onload = function(e) {
    try {
      var data = new Uint8Array(e.target.result);
      var wb = XLSX.read(data, {type:'array', cellDates:true});
      
      // Anchor map: name -> anchor_id (from Dashboard_Data sheet)
      var ANCHOR_MAP = {
        // ××–×•××Ÿ
        '×©×™×§×œ×™': 'CASH_ILS',
        '×“×•×œ×¨×™': 'CASH_USD',
        '××™×˜×‘ ×©×§×œ×™×ª 5136544': 'SAV_MEITAV_CASH',
        // ×§×¨× ×•×ª ×”×©×ª×œ××•×ª - ×©××•×ª ×›×¤×™ ×©××•×¤×™×¢×™× ×‘××§×¡×œ
        '39905556 ××´×© ×§×´×”×©': 'PENS_SH_ALT_39905556',
        '××´×© ×§×´×”×© 6730513': 'PENS_SH_MEITAV_442504',
        '××´×© ×§×”×´×© 40035706': 'PENS_SH_ALT_40035706',
        '××•×¨ ×§×”×´×© 499293': 'PENS_SH_MEITAV_443195',
        '××™×˜×‘ ×§×´×”×© 917-442504': 'PENS_SH_MEITAV_442504',
        '××™×˜×‘ ×§×”×´×© 917-443195': 'PENS_SH_MEITAV_443195',
        // ×§×•×¤×•×ª ×’××œ
        '6730511 ××´×© ×’××œ': 'PENS_GEMEL_MOR_1428298',
        '××•×¨ ×’××œ 1428298': 'PENS_GEMEL_MOR_1428298',
        '××´×© ×’××œ 39774495': 'PENS_GEMEL_MOR_1375688',
        '××•×¨ ×’××œ 1375688': 'PENS_GEMEL_MOR_1375688',
        '6730512 ××´×© ×’××œ': 'PENS_GEMEL_MOR_1375888',
        '1375888 ××•×¨ ×’××œ': 'PENS_GEMEL_MOR_1375888',
        '6899425 ××´×© ×’××œ': 'PENS_GEMEL_MOR_1375911',
        '1375911 ××•×¨ ×’××œ': 'PENS_GEMEL_MOR_1375911',
        '×”×¤× ×™×§×¡ ×’××œ 926-084678': 'PENS_GEMEL_PHX_084678',
        // ×’××œ ×œ×”×©×§×¢×”
        '××´×© ×’××œ ×œ×”×©×§×¢×” 2016-17 38009022': 'INV_GEMEL_MEITAV_917_443197',
        '××™×˜×‘ ×’××œ ×œ×”×©×§×¢×” 917-443197': 'INV_GEMEL_MEITAV_917_443197',
        '××•×¨ ×’××œ ×œ×”×©×§×¢×”': 'INV_GEMEL_MEITAV_912_443197',
        '××•×¨ ×’××œ ×œ×”×©×§×¢×” 470234': 'INV_GEMEL_MEITAV_912_443197',
        '××™×˜×‘ ×’××œ ×œ×”×©×§×¢×” 912-443197': 'INV_GEMEL_MEITAV_912_443197',
        // ×”×¨××œ
        '×”×¨××œ ××’×•×•×Ÿ - ×¤×•×œ×™×¡×ª ×—×™×¡×›×•×Ÿ': 'SAV_HAREL_928884078',
        '×”×¨××œ ××’×•×•×Ÿ - ×¤×•×œ×™×¡×ª ×—×™×¡×›×•×Ÿ ×›×œ×œ×™ 928884078': 'SAV_HAREL_928884078',
        '×”×¨××œ ×× ×™×•×ª 106863031': 'SAV_HAREL_106863031',
        '×”×¨××œ ×›×œ×œ×™ 109062745': 'SAV_HAREL_109062745',
        // ××™×˜×‘
        '××™×˜×‘ ×“×© × ×™×”×•×œ ×§×¨× ×•×ª 169301968': 'SAV_MEITAV_169301968',
        '××™×˜×‘ ×“×© ×˜×¨×™×™×“': 'SAV_MEITAV_TRADE',
        // ×©××¨
        '×“×™×¨×”': 'RE_ISRAEL_MAIN',
        '×—×•×‘ ×”×¨××œ': 'LIAB_HAREL',
        '×—×•×‘ ××œ×˜×©×•×œ×¨': 'LIAB_ALTSHULER',
        '××¨×‘×™×˜×¨××–×³ ×•××œ×™×•': 'SOLD_ARBITRAGE',
      };

      // Fund ID -> FUNDS key mapping
      var ANCHOR_TO_FUND = {
        'CASH_ILS': '××–×•××Ÿ×©×§×œ×™',
        'CASH_USD': '××–×•××Ÿ×“×•×œ×¨×™',
        'PENS_SH_ALT_39905556': '××©×§×”×©39905556',
        'PENS_SH_ALT_40035706': '××©×§×”×©40035706',
        'PENS_SH_MEITAV_442504': '××©×§×”×©6730513',
        'PENS_SH_MEITAV_443195': '××•×¨×§×”×©499293',
        'PENS_GEMEL_MOR_1428298': '6730511××©×’××œ',
        'PENS_GEMEL_MOR_1375688': '××©×’××œ39774495',
        'PENS_GEMEL_MOR_1375888': '6730512××©×’××œ',
        'PENS_GEMEL_MOR_1375911': '6899425××©×’××œ',
        'PENS_GEMEL_PHX_084678': '×”×¤× ×™×§×¡×’××œ926-084678',
        'INV_GEMEL_MEITAV_917_443197': '××©×’××œ×œ×”×©×§×¢×”2016-1738',
        'INV_GEMEL_MEITAV_912_443197': '××•×¨×’××œ×œ×”×©×§×¢×”',
        'SAV_HAREL_928884078': '×”×¨××œ××’×•×•×Ÿ-×¤×•×œ×™×¡×ª×—×™×¡×›',
        'SAV_HAREL_106863031': '×”×¨××œ×× ×™×•×ª106863031',
        'SAV_HAREL_109062745': '×”×¨××œ×›×œ×œ×™109062745',
        'SAV_MEITAV_169301968': '××™×˜×‘×“×©× ×™×”×•×œ×§×¨× ×•×ª1693',
        'SAV_MEITAV_TRADE': '××™×˜×‘×“×©×˜×¨×™×™×“',
        'SAV_MEITAV_CASH': '××™×˜×‘×©×§×œ×™×ª',
        'RE_ISRAEL_MAIN': '×“×™×¨×”',
        'LIAB_HAREL': '×—×•×‘×”×¨××œ',
        'LIAB_ALTSHULER': '×—×•×‘××œ×˜×©×•×œ×¨',
        'SOLD_ARBITRAGE': '××¨×‘×™×˜×¨××–×•××œ×™×•',
      };

      // Parse sheet dates, keep only 2025+
      var MONTH_NAMES = ['×™× ×•','×¤×‘×¨','××¨×¥','××¤×¨','×××™','×™×•× ','×™×•×œ','××•×’','×¡×¤×˜','××•×§','× ×•×‘','×“×¦×'];
      
      function parseSheetDate(name) {
        var clean = name.split('-')[0];
        var parts = clean.split('_');
        if (parts.length === 3) {
          var d = parseInt(parts[0]), m = parseInt(parts[1]), y = parseInt(parts[2]);
          if (y >= 2025 && m >= 1 && m <= 12) return new Date(y, m-1, d);
        }
        return null;
      }

      function monthLabel(d) {
        return MONTH_NAMES[d.getMonth()] + "' " + String(d.getFullYear()).slice(2);
      }

      // Collect sheets per month, keep latest
      var monthSheets = {};
      wb.SheetNames.forEach(function(sname) {
        var d = parseSheetDate(sname);
        if (!d) return;
        var key = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0');
        if (!monthSheets[key] || d > monthSheets[key].date) {
          monthSheets[key] = {date: d, name: sname};
        }
      });

      // Sort months
      var sortedKeys = Object.keys(monthSheets).sort();
      if (sortedKeys.length === 0) {
        status.textContent = '×œ× × ××¦××• ×’×™×œ×™×•× ×•×ª ×ª×§×™× ×™×';
        return;
      }

      // Build new labels and data
      var newLabels = sortedKeys.map(function(k) { return monthLabel(monthSheets[k].date); });
      
      // Init new data per fund key
      var newFundData = {};
      Object.keys(FUNDS).forEach(function(fk) {
        newFundData[fk] = new Array(newLabels.length).fill(null);
      });

      // Fill data from sheets
      sortedKeys.forEach(function(key, colIdx) {
        var sname = monthSheets[key].name;
        var ws = wb.Sheets[sname];
        var rows = XLSX.utils.sheet_to_json(ws, {header:1, defval:null});
        
        rows.forEach(function(row) {
          var cellName = row[0];
          var cellVal = row[1];
          if (!cellName || typeof cellVal !== 'number') return;
          var normName = String(cellName).replace(/[ \t]+/g,' ').trim();
          var anchorId = ANCHOR_MAP[normName];
          if (!anchorId) return;
          var fundKey = ANCHOR_TO_FUND[anchorId];
          if (!fundKey || !newFundData[fundKey]) return;
          newFundData[fundKey][colIdx] = cellVal;
        });
      });

      // Update global data
      LABELS.length = 0;
      newLabels.forEach(function(l) { LABELS.push(l); });
      
      Object.keys(newFundData).forEach(function(fk) {
        if (FUNDS[fk]) FUNDS[fk].data = newFundData[fk];
      });

      // Recalculate CAT_TOTALS and ALL_TOTALS after data update
      Object.keys(CAT_TOTALS).forEach(cat => { CAT_TOTALS[cat].length = 0; });
      LABELS.forEach((_, i) => {
        Object.entries(CAT_TOTALS).forEach(([cat, arr]) => {
          const vals = Object.values(FUNDS).filter(f => f.cat===cat).map(f => f.data[i]||0);
          arr.push(vals.reduce((a,b)=>a+b,0));
        });
      });
      ALL_TOTALS.length = 0;
      LABELS.forEach((_, i) => {
        let t = 0;
        Object.entries(CAT_TOTALS).forEach(([cat, arr]) => { t += cat === 'chov' ? -(arr[i]||0) : (arr[i]||0); });
        ALL_TOTALS.push(t);
      });

      // Update table column headers
      document.querySelectorAll('th[data-col]').forEach(th => {
        const col = parseInt(th.getAttribute('data-col'));
        if (col >= 0 && col < LABELS.length) th.textContent = LABELS[col];
      });

      // Reset window to end
      winStart = Math.max(0, LABELS.length - WINDOW);

      // Rebuild chart totals (excludes sold funds)
      CAT_CHART_TOTALS = buildCatChartTotals();

      // Refresh chart with updated data
      if (currentView && currentView !== 'all') selectView(currentView);
      else selectView('all');

      // Read Notes sheet if exists
      loadNotesFromExcel(wb);

      // Refresh table cells from updated FUNDS data
      updateTableCells();
      saveToLocalStorage();
      markNoteMonths();

      // Refresh UI â€“ reset currentData so chart picks up new arrays
      currentData = (currentView === 'all' || !currentView) ? ALL_TOTALS : (CAT_TOTALS[currentView] || ALL_TOTALS);
      selectView(currentView || 'all');
      updateNavButtons();
      
      status.textContent = 'âœ“ ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”! ' + newLabels.length + ' ×—×•×“×©×™×';
      status.style.color = '#4ade80';
      
      // Reset file input
      input.value = '';
    } catch(err) {
      status.textContent = '×©×’×™××”: ' + err.message;
      status.style.color = '#f87171';
    }
  };
  reader.readAsArrayBuffer(file);
}

</script>